<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MedConvert — Offline Medical Toolkit</title>
    <meta name="description" content="Comprehensive offline medical calculator toolkit — dosage, IV drip, vitals, pediatric, and lab reference.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>

@import url('https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Nunito:wght@300;400;500;600;700;800&display=swap');


:root {
    --forest:     #2d5a27;   /* 1. Deep forest green  — primary actions, headings */
    --sage:       #5c8a52;   /* 2. Sage green         — interactive hover/focus  */
    --moss:       #9dc990;   /* 3. Soft moss           — selected, highlighted    */
    --cream:      #f5f0e8;   /* 4. Warm cream          — page background          */
    --bark:       #6b5744;   /* 5. Muted warm brown    — secondary text           */

    /* Extended tones derived from core palette */
    --fern:       #7aaf6e;
    --parchment:  #ece6d8;
    --linen:      #d9d0bf;
    --chalk:      #fdfaf4;
    --soil:       #2a2018;
    --dusty-rose: #c17a6a;
    --clay:       #8b3a2f;
    --amber:      #9a6c20;

    /* Semantic status — WCAG AA verified on white */
    --success:    #3a6b30;
    --success-bg: #eaf5e8;
    --warning:    #8a5c18;
    --warning-bg: #fdf3e0;
    --danger:     #7a2a22;
    --danger-bg:  #fbeae8;

    /* Surface backgrounds */
    --bg-main:    #f5f0e8;
    --bg-card:    #fdfaf4;
    --bg-input:   #f0ead8;
    --bg-hover:   #e8e0cc;

    /* Text — verified contrast ratios */
    --text-primary:   #2a2018;   /* 14.5:1 on cream */
    --text-secondary: #4e4233;   /* 8.3:1 on cream  */
    --text-muted:     #7a6a58;   /* 4.6:1 on cream  */
    --text-on-dark:   #e8f4e6;

    /* Borders */
    --border:        #cfc7b4;
    --border-medium: #bfb6a0;
    --border-strong: #8a7e6a;
    --border-focus:  #5c8a52;

    /* Focus ring — WCAG 2.4.7 compliant */
    --focus-ring: 0 0 0 3px rgba(92, 138, 82, 0.4);

    /* Typography */
    --font-display: 'Lora', Georgia, 'Times New Roman', serif;
    --font-body:    'Nunito', 'Segoe UI', system-ui, sans-serif;

    /* Modular type scale (1.25 ratio) */
    --text-2xs:  0.75rem;
    --text-xs:   0.8125rem;
    --text-sm:   0.9375rem;
    --text-base: 1.0625rem;
    --text-lg:   1.25rem;
    --text-xl:   1.5rem;
    --text-2xl:  1.875rem;
    --text-3xl:  2.25rem;

    /* 8pt spacing grid */
    --space-1:  0.25rem;
    --space-2:  0.5rem;
    --space-3:  0.75rem;
    --space-4:  1rem;
    --space-5:  1.25rem;
    --space-6:  1.5rem;
    --space-8:  2rem;
    --space-10: 2.5rem;
    --space-12: 3rem;
    --space-16: 4rem;

    /* Border radii — consistent soft rounding system */
    --radius-sm:   0.375rem;
    --radius-md:   0.625rem;
    --radius-lg:   1rem;
    --radius-xl:   1.5rem;
    --radius-2xl:  2rem;
    --radius-full: 9999px;

    /* Fitts's Law — minimum touch target 44px */
    --touch-target: 2.75rem;

    /* Transitions — purposeful, not gratuitous */
    --t-instant: 60ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
    --t-fast:    180ms cubic-bezier(0.25, 0.46, 0.45, 0.94);
    --t-base:    280ms cubic-bezier(0.16, 1, 0.3, 1);
    --t-slow:    420ms cubic-bezier(0.16, 1, 0.3, 1);
    --t-spring:  500ms cubic-bezier(0.34, 1.4, 0.64, 1);
    --t-bounce:  600ms cubic-bezier(0.34, 1.6, 0.64, 1);
    --t-smooth:  350ms cubic-bezier(0.16, 1, 0.3, 1);

    
    --outline-card:   2px solid var(--border);
    --outline-hover:  2px solid var(--border-medium);
    --outline-active: 2px solid var(--sage);
    --outline-focus:  2px solid var(--border-focus);
}

/* ==================== DARK THEME ==================== */
[data-theme="dark"] {
    --bg-main:        #18231a;
    --bg-card:        #1f2e22;
    --bg-input:       #1a2a1c;
    --bg-hover:       #253328;
    --text-primary:   #e6e0d2;
    --text-secondary: #b0a490;
    --text-muted:     #7a7060;
    --text-on-dark:   #e6e0d2;
    --border:         #344838;
    --border-medium:  #445a48;
    --border-strong:  #607a64;
    --border-focus:   #7aaf6e;
    --parchment:      #1a2a1c;
    --linen:          #344838;
    --chalk:          #1f2e22;
    --focus-ring:     0 0 0 3px rgba(122, 175, 110, 0.45);
    --success-bg:     #122a12;
    --warning-bg:     #261e0c;
    --danger-bg:      #281610;
    --dusty-rose:     #c47a6a;
}

/* ==================== RESET ==================== */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    -webkit-tap-highlight-color: rgba(157, 201, 144, 0.25);
}

html {
    font-size: 16px;
    scroll-behavior: smooth;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
    text-size-adjust: 100%;
    -webkit-text-size-adjust: 100%;
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: 1.7;
    color: var(--text-primary);
    background-color: var(--bg-main);
    min-height: 100vh;
    overflow-x: hidden;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3CfeBlend in='SourceGraphic' mode='multiply'/%3E%3C/filter%3E%3Crect width='300' height='300' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
}

::selection { background: rgba(157, 201, 144, 0.45); color: var(--forest); }
::-moz-selection { background: rgba(157, 201, 144, 0.45); color: var(--forest); }
input::selection { background: rgba(92, 138, 82, 0.3); color: var(--text-primary); }
textarea::selection { background: rgba(92, 138, 82, 0.3); color: var(--text-primary); }

/* Skip link */
.skip-link {
    position: absolute;
    top: -100%;
    left: var(--space-4);
    background: var(--forest);
    color: var(--text-on-dark);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-weight: 700;
    font-size: var(--text-sm);
    text-decoration: none;
    z-index: 9999;
    transition: top var(--t-fast);
    border: 2px solid var(--fern);
}
.skip-link:focus { top: var(--space-4); }

/* Focus ring */
:focus-visible {
    outline: 3px solid var(--border-focus);
    outline-offset: 3px;
    border-radius: var(--radius-sm);
}
:focus:not(:focus-visible) { outline: none; }

/* ==================== TYPOGRAPHY ==================== */
/* Typography */
h1, h2, h3, h4 {
    font-family: var(--font-display);
    line-height: 1.22;
    color: var(--forest);
    margin-bottom: var(--space-3);
}

[data-theme="dark"] h1,
[data-theme="dark"] h2,
[data-theme="dark"] h3,
[data-theme="dark"] h4 { color: var(--fern); }

/* Typography scale — clear, proportionate hierarchy */
h1 { font-size: clamp(2rem, 5vw, 2.75rem);      font-weight: 700; letter-spacing: -0.022em; }
h2 { font-size: clamp(1.5rem, 4vw, 2.125rem);    font-weight: 600; letter-spacing: -0.018em; }
h3 { font-size: clamp(1.25rem, 3vw, 1.625rem);   font-weight: 600; letter-spacing: -0.012em; }
h4 { font-size: clamp(1.0625rem, 2.5vw, 1.375rem); font-weight: 600; }

/* Justified paragraphs, generous line-height for readability */
p {
    margin-bottom: var(--space-4);
    line-height: 1.75;
    text-align: left;
    max-width: 72ch;
}

strong, b { font-weight: 700; }


a {
    color: var(--sage);
    text-decoration: underline;
    text-underline-offset: 3px;
    text-decoration-thickness: 1px;
    text-decoration-color: rgba(92, 138, 82, 0.5);
    transition: color var(--t-fast), text-decoration-color var(--t-fast);
    font-weight: 600;
}
a:hover {
    color: var(--forest);
    text-decoration-color: var(--forest);
}

/* ==================== HEADER ==================== */
/* Sticky header */
header {
    background: var(--forest);
    color: var(--text-on-dark);
    padding: var(--space-5) var(--space-6);
    position: sticky;
    top: 0;
    z-index: 200;
    border-bottom: 3px solid var(--sage);
}

[data-theme="dark"] header { background: #0f1a0e; border-bottom-color: var(--fern); }

.header-content { max-width: 1200px; margin: 0 auto; }

.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--space-6);
    margin-bottom: var(--space-3);
}

.header-branding h1 {
    font-family: var(--font-display);
    color: var(--text-on-dark);
    font-size: clamp(1.75rem, 4.5vw, 2.375rem);
    font-weight: 700;
    letter-spacing: -0.022em;
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    line-height: 1.1;
}

.brand-icon { flex-shrink: 0; display: flex; }

.subtitle {
    font-size: var(--text-sm);
    font-family: var(--font-body);
    font-weight: 400;
    color: rgba(232, 244, 230, 0.82);
    line-height: 1.5;
}

.specialty-badge {
    background: rgba(122, 175, 110, 0.28);
    border: 1px solid rgba(122, 175, 110, 0.45);
    padding: 0.1em 0.6em;
    border-radius: var(--radius-full);
    font-size: 0.84em;
    font-weight: 700;
    color: #cde8ca;
    letter-spacing: 0.02em;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-shrink: 0;
}

/* Clock widget — HCI #2: Visibility of system status */
.clock-widget {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.125rem;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.13);
    border-radius: var(--radius-lg);
    padding: var(--space-3) var(--space-4);
}

.clock-time {
    font-family: var(--font-display);
    font-size: clamp(1.25rem, 3vw, 1.625rem);
    font-weight: 500;
    line-height: 1;
    color: var(--text-on-dark);
    letter-spacing: 0.01em;
    font-variant-numeric: tabular-nums;
}

.clock-date {
    font-size: var(--text-2xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    color: rgba(232, 244, 230, 0.7);
}

.greeting {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-style: italic;
    color: rgba(232, 244, 230, 0.85);
    line-height: 1.5;
}

/* Icon buttons */
.icon-btn,
.theme-toggle {
    background: rgba(255,255,255,0.09);
    border: 1px solid rgba(255,255,255,0.16);
    color: var(--text-on-dark);
    width: var(--touch-target);
    height: var(--touch-target);
    border-radius: var(--radius-lg);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
        background var(--t-base),
        border-color var(--t-base),
        transform var(--t-fast);
    flex-shrink: 0;
    position: relative;
}


.icon-btn:hover,
.theme-toggle:hover {
    background: rgba(255,255,255,0.18);
    border-color: rgba(255,255,255,0.28);
    transform: scale(1.06);
}


.icon-btn:active,
.theme-toggle:active {
    transform: scale(0.94);
    background: rgba(255,255,255,0.24);
}

.icon-btn svg,
.theme-toggle svg { width: 1.125rem; height: 1.125rem; }

/* ==================== CONTAINER ==================== */
.container { max-width: 1200px; margin: 0 auto; padding: var(--space-8) var(--space-6); }

/* ==================== SHIFT COUNTDOWN ==================== */

.shift-countdown {
    display: none;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-6);
    font-weight: 600;
    font-size: var(--text-sm);
    font-family: var(--font-body);
    flex-wrap: wrap;
    border: 2px solid transparent;
    transition: all var(--t-base);
}

.cd-pre     { background: var(--parchment); border-color: var(--linen);      color: var(--text-secondary); }
.cd-active  { background: var(--moss);      border-color: var(--fern);        color: var(--forest); }
.cd-ending  { background: #f5e8e5;           border-color: var(--dusty-rose);  color: #7a3025; }

[data-theme="dark"] .cd-ending { background: #2a1612; border-color: #8b5045; color: #d4998a; }

.cd-icon { flex-shrink: 0; display: flex; align-items: center; }
.cd-text { flex: 1; line-height: 1.4; }

.cd-bar {
    width: 100%;
    height: 5px;
    background: rgba(0,0,0,0.08);
    border-radius: var(--radius-full);
    overflow: hidden;
    flex-basis: 100%;
    margin-top: var(--space-2);
}

.cd-fill {
    height: 100%;
    background: var(--sage);
    border-radius: var(--radius-full);
    transition: width 1s ease;
}

.cd-ending .cd-fill { background: var(--dusty-rose); }

/* ==================== DASHBOARD ROW ==================== */
.dashboard-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-6);
    margin-bottom: var(--space-8);
}

.dashboard-widget {
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
    transition: border-color var(--t-base);
}

.dashboard-widget:hover { border-color: var(--border-medium); }

.widget-title {
    font-size: var(--text-xs);
    font-weight: 700;
    font-family: var(--font-body);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    margin-bottom: var(--space-4);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* ==================== TAB NAVIGATION ==================== */


.tab-nav {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    background: var(--bg-card);
    padding: var(--space-2);
    border-radius: var(--radius-xl);
    border: var(--outline-card);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scroll-behavior: smooth;
    overscroll-behavior-x: contain;
    scrollbar-width: thin;
    scrollbar-color: var(--linen) transparent;
}

.tab-nav::-webkit-scrollbar { height: 3px; }
.tab-nav::-webkit-scrollbar-track { background: transparent; }
.tab-nav::-webkit-scrollbar-thumb { background: var(--linen); border-radius: var(--radius-full); }

.tab-btn {
    min-height: var(--touch-target);
    padding: var(--space-2) var(--space-4);
    border: 2px solid transparent;
    background: transparent;
    color: var(--text-secondary);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 700;
    letter-spacing: 0.01em;
    cursor: pointer;
    border-radius: var(--radius-lg);
    
    transition:
        background   var(--t-smooth),
        color        var(--t-smooth),
        border-color var(--t-smooth),
        transform    var(--t-fast);
    will-change: transform, background;
    white-space: nowrap;
    user-select: none;
    display: flex;
    align-items: center;
    gap: var(--space-2);
    position: relative;
}

.tab-btn svg {
    width: 1rem;
    height: 1rem;
    flex-shrink: 0;
    opacity: 0.65;
    transition: opacity var(--t-base), transform var(--t-fast);
}


.tab-btn:hover {
    background: var(--bg-hover);
    color: var(--forest);
    border-color: var(--border);
}

.tab-btn:hover svg { opacity: 1; transform: scale(1.1); }


.tab-btn:active { transform: scale(0.97); }


.tab-btn.active {
    background: var(--forest);
    color: var(--text-on-dark);
    border-color: var(--forest);
}

.tab-btn.active svg { opacity: 1; filter: brightness(2); transform: scale(1.05); }

[data-theme="dark"] .tab-btn.active { background: var(--sage); border-color: var(--sage); color: #f0f8ee; }
[data-theme="dark"] .tab-btn:hover  { background: var(--bg-hover); color: var(--fern); border-color: var(--border); }

/* ==================== CALCULATOR CARDS ==================== */
.calc-card {
    background: var(--bg-card);
    border-radius: var(--radius-2xl);
    padding: var(--space-10);
    border: var(--outline-card);
    display: none;
    transform: translateZ(0);
    backface-visibility: hidden;
}


.calc-card.active {
    display: block;
    animation: panelIn 0.55s cubic-bezier(0.16, 1, 0.3, 1) both;
}

@keyframes panelIn {
    0%   { opacity: 0; transform: translateY(18px) scale(0.985); filter: blur(2px); }
    60%  { opacity: 1; filter: blur(0); }
    100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
}

.card-header {
    margin-bottom: var(--space-8);
    padding-bottom: var(--space-6);
    border-bottom: 2px solid var(--border);
    display: flex;
    align-items: flex-start;
    gap: var(--space-4);
}


.card-header-icon {
    width: 3.25rem;
    height: 3.25rem;
    background: var(--moss);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    border: 2px solid var(--fern);
}

.card-header-icon svg { width: 1.5rem; height: 1.5rem; color: var(--forest); }
[data-theme="dark"] .card-header-icon { background: rgba(122,175,110,0.14); border-color: var(--sage); }
[data-theme="dark"] .card-header-icon svg { color: var(--fern); }

.card-title {
    font-family: var(--font-display);
    font-size: clamp(1.375rem, 4vw, 1.875rem);
    font-weight: 700;
    color: var(--forest);
    margin-bottom: var(--space-2);
    line-height: 1.2;
}

[data-theme="dark"] .card-title { color: var(--fern); }

.card-subtitle {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.65;
    font-family: var(--font-body);
    font-weight: 400;
    max-width: 60ch;
}

/* ==================== FORM ELEMENTS — AFFORDANCE ==================== */
/* Form inputs */

.form-group { margin-bottom: var(--space-6); }

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-5);
    margin-bottom: var(--space-5);
}


label {
    display: block;
    font-size: var(--text-xs);
    font-weight: 700;
    color: var(--text-secondary);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-family: var(--font-body);
    user-select: none;
    cursor: default;
}


input[type="number"],
input[type="text"],
input[type="time"],
select {
    width: 100%;
    min-height: var(--touch-target);   /* Fitts's Law */
    padding: var(--space-3) var(--space-4);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 500;
    
    background: var(--chalk);
    color: var(--text-primary);
    transition:
        border-color var(--t-base),
        background   var(--t-base),
        box-shadow   var(--t-base);
    outline: none;
    line-height: 1.5;
}


input[type="number"]:hover:not(:focus),
input[type="text"]:hover:not(:focus),
input[type="time"]:hover:not(:focus),
select:hover:not(:focus) {
    border-color: var(--border-medium);
    background: var(--bg-card);
}


input[type="number"]:focus,
input[type="text"]:focus,
input[type="time"]:focus,
select:focus {
    border-color: var(--border-focus);
    background: var(--bg-card);
    box-shadow: var(--focus-ring);
    outline: none;
    caret-color: var(--sage);
}


input.input-error  { border-color: var(--danger); background: var(--danger-bg); }
input.input-error:focus  { box-shadow: 0 0 0 3px rgba(122, 42, 34, 0.25); }
input.input-success { border-color: var(--success); }
input.input-success:focus { box-shadow: 0 0 0 3px rgba(58, 107, 48, 0.25); }

/* Field-level error message */
.field-error {
    display: none;
    margin-top: var(--space-2);
    font-size: var(--text-xs);
    font-weight: 700;
    color: var(--clay);
    font-family: var(--font-body);
    align-items: center;
    gap: var(--space-1);
}
.field-error.visible { display: flex; }
.field-error svg { width: 0.875rem; height: 0.875rem; flex-shrink: 0; }

input::placeholder,
textarea::placeholder { color: var(--text-muted); font-weight: 400; }

/* Hide number spinners */
input[type="number"] { -moz-appearance: textfield; }
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; }

/* Select chevron */
select {
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%235a4e3e' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.75rem;
}

[data-theme="dark"] select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16'%3E%3Cpath fill='%23b0a490' d='M8 11L3 6h10z'/%3E%3C/svg%3E");
}

textarea {
    width: 100%;
    min-height: 280px;
    resize: vertical;
    padding: var(--space-5);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 500;
    background: var(--chalk);
    color: var(--text-primary);
    line-height: 1.8;
    transition: border-color var(--t-base), background var(--t-base), box-shadow var(--t-base);
    outline: none;
}

textarea:hover:not(:focus) { border-color: var(--border-medium); }
textarea:focus {
    border-color: var(--border-focus);
    background: var(--bg-card);
    box-shadow: var(--focus-ring);
}
textarea::placeholder { color: var(--text-muted); font-weight: 400; }

input[type="checkbox"] {
    width: 1.125rem;
    height: 1.125rem;
    cursor: pointer;
    accent-color: var(--sage);
    margin-right: var(--space-3);
    flex-shrink: 0;
}
/* Override browser blue on ALL interactive elements for mobile */
input, select, textarea, button {
    accent-color: var(--sage);
}
:root { color-scheme: light; }
[data-theme="dark"] { color-scheme: dark; }

/* ==================== BUTTONS — AFFORDANCE + FITTS'S LAW ==================== */
/* Buttons */
.btn {
    min-height: var(--touch-target);
    padding: var(--space-3) var(--space-7, 1.75rem);
    border: 2px solid transparent;
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 700;
    letter-spacing: 0.01em;
    cursor: pointer;
    transition:
        background     var(--t-smooth),
        border-color   var(--t-smooth),
        color          var(--t-smooth),
        transform      var(--t-fast),
        box-shadow     var(--t-smooth);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    user-select: none;
    line-height: 1.2;
    position: relative;
    overflow: hidden;
    text-decoration: none;
    will-change: transform;
    -webkit-font-smoothing: antialiased;
    backface-visibility: hidden;
}

.btn svg { width: 1rem; height: 1rem; flex-shrink: 0; transition: transform var(--t-fast); }


.btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
.btn:hover svg { transform: scale(1.1); }


.btn:active { transform: translateY(0) scale(0.975); }


.btn::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.15);
    opacity: 0;
    transition: opacity var(--t-instant);
    border-radius: inherit;
    pointer-events: none;
}
.btn:active::after { opacity: 1; }

/* Primary */
.btn-primary {
    background: var(--forest);
    color: var(--text-on-dark);
    border-color: var(--forest);
}
.btn-primary:hover { background: var(--sage); border-color: var(--sage); }

/* Secondary */
.btn-secondary {
    background: var(--bg-input);
    color: var(--text-primary);
    border-color: var(--border);
}
.btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-medium); color: var(--forest); }

/* Accent */
.btn-accent {
    background: var(--dusty-rose);
    color: #fff;
    border-color: var(--dusty-rose);
}
.btn-accent:hover { background: var(--clay); border-color: var(--clay); }

/* Loading state */
.btn.btn-loading { pointer-events: none; }
.btn.btn-loading::before {
    content: '';
    width: 1rem;
    height: 1rem;
    border: 2px solid rgba(255,255,255,0.35);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.65s linear infinite;
    flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Disabled */
.btn:disabled, .btn[aria-disabled="true"] {
    opacity: 0.45;
    cursor: not-allowed;
    transform: none;
    pointer-events: none;
}

.btn-group { display: flex; gap: var(--space-4); flex-wrap: wrap; align-items: center; }
.btn-full { width: 100%; }

/* ==================== SUB TABS ==================== */

.sub-tabs {
    display: flex;
    gap: var(--space-2);
    margin-bottom: var(--space-8);
    padding: var(--space-2);
    background: var(--bg-input);
    border-radius: var(--radius-lg);
    border: var(--outline-card);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.sub-tab {
    flex: 1;
    min-width: fit-content;
    min-height: 2.5rem;
    padding: var(--space-2) var(--space-4);
    border: 2px solid transparent;
    background: transparent;
    color: var(--text-secondary);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 700;
    letter-spacing: 0.01em;
    cursor: pointer;
    border-radius: var(--radius-md);
    transition: all var(--t-base);
    white-space: nowrap;
    user-select: none;
}

.sub-tab:hover { background: rgba(255,255,255,0.75); color: var(--forest); border-color: var(--border); }
.sub-tab:active { transform: scale(0.97); }
.sub-tab.active { background: var(--bg-card); color: var(--forest); border-color: var(--border-medium); }

[data-theme="dark"] .sub-tab.active { background: var(--bg-card); color: var(--fern); border-color: var(--border-medium); }
[data-theme="dark"] .sub-tab:hover  { background: rgba(255,255,255,0.06); color: var(--fern); }

.sub-panel { display: none; }
.sub-panel.active { display: block; animation: panelIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) both; }

/* ==================== TIMER DISPLAY ==================== */

.timer-display {
    background: var(--parchment);
    border-radius: var(--radius-2xl);
    padding: var(--space-12) var(--space-8);
    text-align: center;
    margin-bottom: var(--space-8);
    border: 2px solid var(--linen);
    position: relative;
    overflow: hidden;
}

.timer-display::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: var(--sage);
    border-radius: var(--radius-full) var(--radius-full) 0 0;
}

.timer-countdown {
    font-family: var(--font-display);
    font-size: clamp(3.5rem, 14vw, 5.5rem);
    font-weight: 700;
    color: var(--forest);
    letter-spacing: 0.04em;
    margin-bottom: var(--space-3);
    line-height: 1;
    transition: color var(--t-fast);
    font-variant-numeric: tabular-nums;
}

.timer-label {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    font-weight: 700;
    font-family: var(--font-body);
}

.timer-presets {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: var(--space-3);
    margin-bottom: var(--space-6);
}


.timer-btn {
    min-height: var(--touch-target);
    padding: var(--space-4) var(--space-3);
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--t-base);
    text-align: center;
    font-family: var(--font-body);
}

.timer-btn:hover { border-color: var(--sage); background: var(--moss); transform: translateY(-2px); }
.timer-btn:active { transform: translateY(0) scale(0.97); }

.timer-time {
    font-family: var(--font-display);
    font-size: clamp(1.25rem, 3vw, 1.5rem);
    font-weight: 700;
    color: var(--forest);
    display: block;
    font-variant-numeric: tabular-nums;
}

.timer-desc { font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-1); display: block; font-weight: 600; }

/* ==================== RESULT DISPLAY ==================== */
/* Result display */
.result-display {
    background: var(--parchment);
    border: var(--outline-active);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    margin-top: var(--space-8);
    display: none;
}

.result-display.show {
    display: block;
    animation: resultPop 0.55s cubic-bezier(0.16, 1, 0.3, 1) both;
}

@keyframes resultPop {
    0%   { opacity: 0; transform: translateY(12px) scale(0.96); }
    65%  { transform: translateY(-2px) scale(1.005); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

.result-label {
    font-size: var(--text-xs);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.09em;
    margin-bottom: var(--space-2);
    font-weight: 700;
    font-family: var(--font-body);
}

.result-value {
    font-family: var(--font-display);
    font-size: clamp(2rem, 6vw, 2.875rem);
    font-weight: 700;
    color: var(--forest);
    margin-bottom: var(--space-3);
    line-height: 1.15;
    word-break: break-word;
    font-variant-numeric: tabular-nums;
}

.result-note { font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.65; margin-top: var(--space-3); font-weight: 500; }

.result-interpretation {
    margin-top: var(--space-4);
    padding: var(--space-4) var(--space-5);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    line-height: 1.65;
    border-left: 4px solid var(--sage);
    font-weight: 500;
}

/* Colour-coded status — consistent semantic system */
.result-display.result-normal  { background: var(--success-bg); border-color: var(--success); }
.result-display.result-normal  .result-value { color: var(--success); }
.result-display.result-normal  .result-interpretation { border-left-color: var(--success); }

.result-display.result-warning { background: var(--warning-bg); border-color: var(--amber); }
.result-display.result-warning .result-value { color: var(--warning); }
.result-display.result-warning .result-interpretation { border-left-color: var(--amber); }

.result-display.result-danger  { background: var(--danger-bg); border-color: var(--clay); }
.result-display.result-danger  .result-value { color: var(--clay); }
.result-display.result-danger  .result-interpretation { border-left-color: var(--clay); }

.result-display.result-neutral { background: var(--parchment); border-color: var(--sage); }
.result-display.result-neutral .result-value { color: var(--forest); }

[data-theme="dark"] .result-display.result-normal  { background: var(--success-bg); }
[data-theme="dark"] .result-display.result-warning { background: var(--warning-bg); }
[data-theme="dark"] .result-display.result-danger  { background: var(--danger-bg); }
[data-theme="dark"] .result-display.result-neutral { background: var(--bg-input); }

/* ==================== INFO BOX ==================== */
.info-box {
    background: var(--parchment);
    border-left: 4px solid var(--dusty-rose);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    margin-top: var(--space-6);
}

.info-box p { margin: 0; font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.7; }
.info-box p + p { margin-top: var(--space-3); }
.info-box strong { color: var(--text-primary); font-weight: 700; }

/* ==================== REFERENCE TABLES ==================== */
.reference-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin-top: var(--space-6);
    font-size: var(--text-sm);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    overflow: hidden;
    font-family: var(--font-body);
}

.reference-table th,
.reference-table td { padding: var(--space-4) var(--space-5); text-align: left; border-bottom: 1px solid var(--border); line-height: 1.5; }

.reference-table th {
    background: var(--parchment);
    font-weight: 700;
    color: var(--text-primary);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    font-size: var(--text-xs);
}

.reference-table tbody tr { transition: background var(--t-fast); }
.reference-table tbody tr:hover { background: var(--bg-hover); }
.reference-table tbody tr:last-child td { border-bottom: none; }

/* ==================== QUICK REF CARDS ==================== */
.quick-ref-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(145px, 1fr));
    gap: var(--space-4);
    margin-top: var(--space-6);
}

.quick-ref-card {
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
    transition: all var(--t-base);
}

.quick-ref-card:hover { border-color: var(--sage); transform: translateY(-3px); }

.quick-ref-title {
    font-size: var(--text-xs);
    color: var(--text-muted);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-weight: 700;
    font-family: var(--font-body);
}

.quick-ref-value { font-family: var(--font-display); font-size: clamp(1.125rem, 3vw, 1.5rem); color: var(--forest); font-weight: 700; line-height: 1.3; }
[data-theme="dark"] .quick-ref-value { color: var(--fern); }

/* ==================== CONVERTER ==================== */
.converter-live {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: var(--space-5);
    align-items: center;
}

.converter-arrow { display: flex; align-items: center; justify-content: center; color: var(--text-muted); flex-shrink: 0; }
.converter-arrow svg { width: 1.5rem; height: 1.5rem; }

/* ==================== PINNED TOOLS ==================== */
.pinned-empty {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4) var(--space-5);
    background: var(--bg-input);
    border: 2px dashed var(--linen);
    border-radius: var(--radius-xl);
    color: var(--text-muted);
    font-size: var(--text-sm);
    font-family: var(--font-body);
    flex-wrap: wrap;
    line-height: 1.5;
}

.pinned-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
    gap: var(--space-3);
}


.pinned-btn {
    min-height: var(--touch-target);
    padding: var(--space-3) var(--space-4);
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    color: var(--text-primary);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--t-base);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    white-space: nowrap;
}

.pinned-btn svg { width: 0.875rem; height: 0.875rem; opacity: 0.65; transition: opacity var(--t-fast), transform var(--t-fast); }
.pinned-btn:hover { border-color: var(--sage); background: var(--moss); color: var(--forest); transform: translateY(-2px); }
.pinned-btn:hover svg { opacity: 1; transform: scale(1.1); }
.pinned-btn:active { transform: translateY(0) scale(0.97); }

.pin-manage-btn {
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-size: var(--text-xs);
    font-weight: 700;
    padding: 0.25rem 0.625rem;
    min-height: 1.75rem;
    cursor: pointer;
    transition: all var(--t-fast);
    font-family: var(--font-body);
    letter-spacing: 0.02em;
}
.pin-manage-btn:hover { border-color: var(--sage); color: var(--sage); }

/* ==================== CALC HISTORY ==================== */
.history-empty {
    padding: var(--space-5);
    background: var(--bg-input);
    border-radius: var(--radius-lg);
    color: var(--text-muted);
    font-size: var(--text-sm);
    font-family: var(--font-body);
    text-align: center;
    border: 2px dashed var(--linen);
    line-height: 1.6;
}

.history-item {
    display: grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    gap: 0.1rem var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-2);
    transition: border-color var(--t-fast);
}
.history-item:hover { border-color: var(--sage); }
.history-meta { display: flex; align-items: center; gap: var(--space-2); grid-column: 1/-1; margin-bottom: 0.1rem; }

.history-cat {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--forest);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--moss);
    padding: 0.1em 0.55em;
    border-radius: var(--radius-full);
    font-family: var(--font-body);
}

.history-time { font-size: 0.7rem; color: var(--text-muted); margin-left: auto; font-family: var(--font-body); font-weight: 600; }
.history-label { font-size: var(--text-xs); color: var(--text-secondary); font-weight: 600; font-family: var(--font-body); }
.history-value { font-size: var(--text-sm); font-weight: 700; color: var(--forest); text-align: right; grid-row: 2; grid-column: 2; font-family: var(--font-display); }
[data-theme="dark"] .history-value { color: var(--fern); }

/* ==================== DRUG REFERENCE ==================== */
.drug-search-row { display: grid; grid-template-columns: 1fr auto; gap: var(--space-4); margin-bottom: var(--space-4); align-items: end; }
.drug-filter-row { display: grid; grid-template-columns: 1fr auto; gap: var(--space-4); margin-bottom: var(--space-6); align-items: center; }
.drug-count { font-size: var(--text-sm); color: var(--text-muted); font-weight: 700; white-space: nowrap; font-family: var(--font-body); }

#drug-results { display: flex; flex-direction: column; gap: var(--space-4); }

.drug-placeholder {
    padding: var(--space-10) var(--space-6);
    background: var(--bg-input);
    border: 2px dashed var(--linen);
    border-radius: var(--radius-xl);
    color: var(--text-muted);
    text-align: center;
    font-size: var(--text-base);
    font-family: var(--font-body);
    line-height: 1.7;
}

.drug-card {
    background: var(--bg-card);
    border: var(--outline-card);
    border-radius: var(--radius-xl);
    padding: var(--space-6);
    transition: border-color var(--t-base), transform var(--t-base);
}

.drug-card:hover { border-color: var(--sage); transform: translateY(-2px); }

.drug-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-4); gap: var(--space-3); flex-wrap: wrap; }

.drug-name {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text-primary);
    transition: color var(--t-fast);
    line-height: 1.2;
}

.drug-card:hover .drug-name { color: var(--forest); }

.drug-badge { padding: 0.2em 0.8em; background: var(--moss); color: var(--forest); border-radius: var(--radius-full); font-size: var(--text-xs); font-weight: 700; white-space: nowrap; font-family: var(--font-body); letter-spacing: 0.02em; }
.drug-meta { display: flex; flex-wrap: wrap; gap: var(--space-2); margin-bottom: var(--space-4); }
.drug-tag { display: inline-flex; align-items: center; gap: 0.3em; padding: 0.25em 0.7em; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-full); font-size: var(--text-xs); color: var(--text-secondary); font-weight: 600; font-family: var(--font-body); }
.drug-tag svg { width: 0.75rem; height: 0.75rem; }
.drug-dose { font-size: var(--text-base); font-family: var(--font-body); color: var(--text-primary); line-height: 1.65; margin-bottom: var(--space-3); padding: var(--space-3) var(--space-4); background: var(--parchment); border-radius: var(--radius-md); border-left: 3px solid var(--sage); font-weight: 500; }
.drug-notes { font-size: var(--text-sm); font-family: var(--font-body); color: var(--text-secondary); line-height: 1.7; padding: var(--space-3) var(--space-4); background: #f5ece8; border-radius: var(--radius-md); border-left: 3px solid var(--dusty-rose); }
[data-theme="dark"] .drug-notes { background: #2a1e1c; }

/* ==================== ONBOARDING OVERLAY ==================== */
#onboarding-overlay, #pin-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 25, 14, 0.72);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-6);
    opacity: 0;
    transition: opacity 0.35s ease;
}

#onboarding-overlay.visible, #pin-overlay.visible { opacity: 1; }
#onboarding-overlay.hiding,  #pin-overlay.hiding  { opacity: 0; }

.onboarding-card {
    background: var(--bg-card);
    border-radius: var(--radius-2xl);
    padding: var(--space-10);
    max-width: 480px;
    width: 100%;
    border: var(--outline-card);
    transform: translateY(20px) scale(0.97);
    transition: transform var(--t-spring);
    max-height: 92vh;
    overflow-y: auto;
    scrollbar-width: thin;
}

#onboarding-overlay.visible .onboarding-card,
#pin-overlay.visible .onboarding-card { transform: translateY(0) scale(1); }

.onboarding-logo { text-align: center; margin-bottom: var(--space-4); display: flex; justify-content: center; color: var(--forest); }
.onboarding-logo svg { width: 3.5rem; height: 3.5rem; }
[data-theme="dark"] .onboarding-logo { color: var(--fern); }

.onboarding-title { font-family: var(--font-display); font-size: clamp(1.5rem, 4vw, 1.875rem); color: var(--forest); text-align: center; margin-bottom: var(--space-3); font-weight: 700; }
[data-theme="dark"] .onboarding-title { color: var(--fern); }

.onboarding-subtitle { font-size: var(--text-sm); font-family: var(--font-body); color: var(--text-secondary); text-align: center; margin-bottom: var(--space-8); line-height: 1.6; }

.onboarding-field { margin-bottom: var(--space-6); }
.onboarding-field label { display: block; font-size: var(--text-xs); font-weight: 700; color: var(--text-secondary); margin-bottom: var(--space-2); text-transform: uppercase; letter-spacing: 0.07em; }

.shift-picker { display: flex; gap: var(--space-3); }

.shift-opt {
    flex: 1;
    min-height: var(--touch-target);
    padding: var(--space-3);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    background: var(--bg-input);
    color: var(--text-secondary);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--t-base);
    text-align: center;
}

.shift-opt:hover { border-color: var(--sage); background: rgba(157,201,144,0.1); }
.shift-opt.selected { border-color: var(--sage); background: var(--moss); color: var(--forest); }

.shift-time-row { display: flex; align-items: center; gap: var(--space-4); }
.shift-time-row > div { flex: 1; }

.time-lbl { display: block; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); margin-bottom: var(--space-2); text-transform: uppercase; letter-spacing: 0.07em; }
.time-sep { font-size: 1.5rem; color: var(--text-muted); padding-top: 1.5rem; flex-shrink: 0; }


.onboarding-submit {
    width: 100%;
    min-height: var(--touch-target);
    padding: var(--space-3) var(--space-6);
    background: var(--forest);
    color: var(--text-on-dark);
    border: 2px solid var(--forest);
    border-radius: var(--radius-lg);
    font-family: var(--font-body);
    font-size: var(--text-base);
    font-weight: 700;
    cursor: pointer;
    transition: all var(--t-base);
    margin-top: var(--space-6);
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1.2;
}
.onboarding-submit:hover { background: var(--sage); border-color: var(--sage); transform: translateY(-2px); }
.onboarding-submit:active { transform: translateY(0) scale(0.98); }

/* ==================== PIN MANAGER ==================== */
.pin-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-6); }

.pin-option {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    min-height: var(--touch-target);
    border: var(--outline-card);
    border-radius: var(--radius-lg);
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: 600;
    transition: all var(--t-fast);
    font-family: var(--font-body);
    color: var(--text-primary);
}

.pin-option:hover { border-color: var(--sage); background: rgba(157,201,144,0.08); }
.pin-option.pinned { border-color: var(--sage); background: var(--moss); color: var(--forest); font-weight: 700; }
.pin-option input { width: 1rem; height: 1rem; flex-shrink: 0; accent-color: var(--sage); cursor: pointer; }

/* ==================== TOAST NOTIFICATIONS ==================== */
/* Toast */
.mc-toast {
    position: fixed;
    bottom: 2.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(0.875rem);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-full);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: 700;
    z-index: 10000;
    opacity: 0;
    transition: all var(--t-spring);
    white-space: nowrap;
    max-width: 90vw;
    text-align: center;
    border: 2px solid transparent;
    letter-spacing: 0.02em;
    pointer-events: none;
}

.mc-toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

.toast-info    { background: var(--soil); color: #e8e2d4; border-color: var(--bark); }
.toast-success { background: var(--success); color: white; border-color: #2a5020; }
.toast-warning { background: var(--warning); color: white; }
.toast-danger  { background: var(--clay); color: white; }

/* ==================== BACK TO TOP ==================== */


.back-to-top {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 3.25rem;
    height: 3.25rem;
    background: var(--forest);
    color: var(--text-on-dark);
    border: 2px solid var(--sage);
    border-radius: var(--radius-full);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 300;
    opacity: 0;
    transform: translateY(12px) scale(0.85);
    pointer-events: none;
    transition: background var(--t-base), border-color var(--t-base), transform var(--t-spring), opacity var(--t-base);
}

.back-to-top.visible {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
}


.back-to-top:hover {
    background: var(--sage);
    border-color: var(--moss);
    transform: translateY(-4px) scale(1.06);
}

.back-to-top:active { transform: translateY(0) scale(0.95); }
.back-to-top svg { width: 1.25rem; height: 1.25rem; }

/* ==================== FOOTER ==================== */
footer {
    margin-top: var(--space-16);
    background: var(--chalk);
    border-top: 1px solid var(--border);
}

[data-theme="dark"] footer { background: var(--bg-card); }

.footer-inner {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-12) var(--space-6) var(--space-10);
}

/* Daily reminder — its own clearly separated section */
.footer-daily-section {
    text-align: center;
    padding-bottom: var(--space-10);
    border-bottom: 1px solid var(--border);
    margin-bottom: var(--space-8);
}

.footer-daily-label {
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-muted);
    margin-bottom: var(--space-5);
}

.daily-message {
    font-family: var(--font-display);
    font-size: clamp(1.125rem, 2.5vw, 1.5rem);
    font-weight: 500;
    font-style: italic;
    color: var(--forest);
    line-height: 1.75;
    max-width: 580px;
    margin: 0 auto;
}

[data-theme="dark"] .daily-message { color: var(--fern); }

/* Bottom meta row */
.footer-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.footer-dot-item {
    font-size: var(--text-xs);
    font-family: var(--font-body);
    font-weight: 600;
    color: var(--text-muted);
    letter-spacing: 0.03em;
}

.footer-separator {
    color: var(--border-medium);
    font-size: var(--text-sm);
}

@media (max-width: 480px) {
    .footer-separator { display: none; }
    .footer-meta { flex-direction: column; gap: var(--space-2); }
}

/* ==================== UTILITY CLASSES ==================== */
.hidden   { display: none !important; }

.sr-only  { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
.mt-lg    { margin-top: var(--space-8); }
.mt-md    { margin-top: var(--space-6); }
.mb-md    { margin-bottom: var(--space-6); }
.text-center { text-align: center; }

/* ==================== SCROLL REVEAL ==================== */

.reveal { opacity: 0; transform: translateY(22px); transition: opacity 0.65s cubic-bezier(0.16, 1, 0.3, 1), transform 0.65s cubic-bezier(0.16, 1, 0.3, 1); }
.reveal.visible { opacity: 1; transform: translateY(0); }

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .converter-live { grid-template-columns: 1fr; gap: var(--space-4); }
    .converter-arrow { transform: rotate(90deg); }
    .form-row { grid-template-columns: 1fr; }
    .calc-card { padding: var(--space-6); }
    .container { padding: var(--space-6) var(--space-4); }
    header { padding: var(--space-5) var(--space-4); }
    .header-top { flex-direction: column; gap: var(--space-4); }
    .header-controls { width: 100%; justify-content: flex-end; }
    .clock-widget { width: 100%; flex-direction: row; align-items: center; justify-content: space-between; }
    .dashboard-row { grid-template-columns: 1fr; }
    .pin-grid { grid-template-columns: 1fr; }
    .drug-search-row { grid-template-columns: 1fr; }
    .drug-filter-row { grid-template-columns: 1fr; }
    .shift-time-row { flex-direction: column; gap: var(--space-3); }
    .time-sep { padding: 0; display: none; }
    .timer-presets { grid-template-columns: repeat(2, 1fr); }
    .quick-ref-grid { grid-template-columns: repeat(2, 1fr); }
    .back-to-top { bottom: 1.25rem; right: 1.25rem; width: 3rem; height: 3rem; }
    .tab-btn { padding: var(--space-2) var(--space-3); font-size: 0.72rem; }
    .btn-group { gap: var(--space-3); }
    .card-header { gap: var(--space-3); }
    .card-header-icon { width: 2.75rem; height: 2.75rem; }
}

@media (max-width: 480px) {
    .timer-presets { grid-template-columns: repeat(2, 1fr); }
    .quick-ref-grid { grid-template-columns: repeat(2, 1fr); }
    .shift-picker { flex-direction: column; gap: var(--space-2); }
    .calc-card { padding: var(--space-5); border-radius: var(--radius-xl); }
}

/* ==================== PRINT ==================== */
@media print {
    header, .tab-nav, footer, .btn, .back-to-top, .shift-countdown { display: none; }
    .calc-card { box-shadow: none; border: 1px solid #ccc; page-break-inside: avoid; display: block !important; margin-bottom: 2rem; }
    body { background: white; }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    .reveal { opacity: 1; transform: none; }
}

/* High contrast */
@media (prefers-contrast: high) {
    :root { --border: #555; --text-muted: #444; --text-secondary: #222; }
    .tab-btn { border-color: currentColor; }
    .tab-btn.active { outline: 2px solid white; outline-offset: -2px; }
    .btn-primary { border-width: 3px; }
}
/* ==================== IMPROVEMENTS PATCH ==================== */

/* Compact header */
header {
    padding: var(--space-3) var(--space-6);
}
.header-top {
    margin-bottom: var(--space-2);
}
.greeting {
    margin-top: 0;
    font-size: var(--text-2xs);
}

/* Offline badge */
.offline-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.18);
    font-size: var(--text-2xs);
    font-weight: 700;
    font-family: var(--font-body);
    color: var(--text-on-dark);
    letter-spacing: 0.04em;
    transition: all var(--t-base);
    cursor: default;
    user-select: none;
}

.offline-dot {
    width: 0.5rem;
    height: 0.5rem;
    border-radius: 50%;
    background: #6ee48a;
    box-shadow: 0 0 6px #6ee48a;
    flex-shrink: 0;
    transition: background var(--t-base), box-shadow var(--t-base);
}

.offline-badge.is-offline .offline-dot {
    background: var(--dusty-rose);
    box-shadow: 0 0 6px var(--dusty-rose);
}
.offline-badge.is-offline .offline-label {
    color: #f0a090;
}

/* Tab nav wrapper with fade hint */
.tab-nav-wrapper {
    position: relative;
    margin-bottom: var(--space-8);
}

.tab-nav-wrapper .tab-nav {
    margin-bottom: 0;
}

.tab-fade-right {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 3.5rem;
    border-radius: 0 var(--radius-xl) var(--radius-xl) 0;
    background: linear-gradient(to right, transparent, var(--bg-card) 80%);
    pointer-events: none;
    z-index: 2;
    transition: opacity var(--t-base);
}

.tab-nav-wrapper.at-end .tab-fade-right {
    opacity: 0;
}

/* Timer SVG ring */
.timer-ring-wrap {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    width: clamp(140px, 35vw, 180px);
    height: clamp(140px, 35vw, 180px);
}

.timer-ring {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
}

.timer-ring-bg {
    stroke: var(--linen);
}

.timer-ring-fill {
    stroke: var(--sage);
    transition: stroke-dashoffset 1s linear, stroke var(--t-base);
}

.timer-ring-fill.ring-urgent {
    stroke: var(--dusty-rose);
}

.timer-ring-inner {
    position: relative;
    z-index: 1;
    text-align: center;
}

.timer-ring-inner .timer-countdown {
    font-size: clamp(2.25rem, 8vw, 3.25rem);
    margin-bottom: var(--space-1);
}

.timer-ring-inner .timer-label {
    font-size: 0.65rem;
}

/* Remove the old timer-display padding since ring takes care of visual space */
.timer-display {
    padding: var(--space-8);
}

/* Copy result button */
.result-copy-btn {
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    background: transparent;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-size: var(--text-xs);
    font-weight: 700;
    font-family: var(--font-body);
    padding: 0.2rem 0.6rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    transition: all var(--t-fast);
    letter-spacing: 0.02em;
}
.result-copy-btn:hover {
    border-color: var(--sage);
    color: var(--forest);
    background: var(--bg-hover);
}
.result-copy-btn svg { width: 0.75rem; height: 0.75rem; }

.result-display {
    position: relative;
}

/* Clear inputs button */
.calc-clear-btn {
    background: transparent;
    border: 1px dashed var(--border);
    border-radius: var(--radius-md);
    color: var(--text-muted);
    font-size: var(--text-xs);
    font-weight: 700;
    font-family: var(--font-body);
    padding: 0.3rem 0.75rem;
    cursor: pointer;
    transition: all var(--t-fast);
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 0.3rem;
    min-height: 2rem;
}
.calc-clear-btn:hover {
    border-color: var(--dusty-rose);
    color: var(--clay);
}
.calc-clear-btn svg { width: 0.75rem; height: 0.75rem; }

/* Styled confirm modal */
.confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(15, 25, 14, 0.72);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-6);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s ease;
}

.confirm-overlay.visible {
    opacity: 1;
    pointer-events: auto;
}

.confirm-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: var(--space-8);
    max-width: 380px;
    width: 100%;
    border: var(--outline-card);
    transform: translateY(16px) scale(0.97);
    transition: transform var(--t-spring);
    text-align: center;
}

.confirm-overlay.visible .confirm-card {
    transform: translateY(0) scale(1);
}

.confirm-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    color: var(--clay);
    margin-bottom: var(--space-3);
}

.confirm-body {
    font-size: var(--text-sm);
    color: var(--text-secondary);
    line-height: 1.65;
    margin-bottom: var(--space-6);
    max-width: unset;
}

.confirm-actions {
    display: flex;
    gap: var(--space-4);
    justify-content: center;
}

/* Unit toggle */
.unit-toggle-group {
    display: inline-flex;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    overflow: hidden;
    margin-left: var(--space-3);
    vertical-align: middle;
}

.unit-toggle-btn {
    padding: 0.1em 0.55em;
    background: transparent;
    border: none;
    color: var(--text-muted);
    font-size: 0.7rem;
    font-weight: 700;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all var(--t-fast);
    min-height: 1.5rem;
    letter-spacing: 0.04em;
}

.unit-toggle-btn.active {
    background: var(--forest);
    color: var(--text-on-dark);
}

[data-theme="dark"] .unit-toggle-btn.active {
    background: var(--sage);
}

/* Drug "Show All" button */
.drug-showall-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-5);
    background: var(--bg-input);
    border: var(--outline-card);
    border-radius: var(--radius-full);
    color: var(--text-secondary);
    font-size: var(--text-sm);
    font-weight: 700;
    font-family: var(--font-body);
    cursor: pointer;
    transition: all var(--t-fast);
    margin-top: var(--space-4);
}

.drug-showall-btn:hover {
    border-color: var(--sage);
    color: var(--forest);
    background: var(--moss);
}

/* Normal range highlight in lab results */
.normal-range-highlight {
    display: inline-block;
    margin-top: var(--space-4);
    padding: var(--space-2) var(--space-4);
    background: var(--success-bg);
    border: 1px solid var(--success);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: 700;
    color: var(--success);
    font-family: var(--font-body);
    letter-spacing: 0.02em;
}

[data-theme="dark"] .normal-range-highlight {
    background: #0f2a0f;
}

/* Responsive: mobile header */
@media (max-width: 768px) {
    .offline-badge .offline-label { display: none; }
    .offline-badge { padding: 0.3rem 0.4rem; }
}


/* ==================== SMOOTH ANIMATION POLISH ==================== */

/* GPU layer for all animated elements */
.tab-btn,
.btn,
.calc-card,
.timer-btn,
.drug-card,
.quick-ref-card,
.dashboard-widget,
.pinned-btn,
.back-to-top,
.result-display,
.sub-tab {
    transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* Staggered reveal for dashboard widgets */
.dashboard-row .dashboard-widget:nth-child(1) { transition-delay: 0ms; }
.dashboard-row .dashboard-widget:nth-child(2) { transition-delay: 60ms; }

/* Smooth card hover lift */
.drug-card {
    transition: border-color var(--t-smooth), transform var(--t-smooth), box-shadow var(--t-smooth);
}
.drug-card:hover {
    transform: translateY(-3px) translateZ(0);
    box-shadow: 0 8px 24px rgba(45, 90, 39, 0.1);
}

.quick-ref-card {
    transition: border-color var(--t-smooth), transform var(--t-smooth), box-shadow var(--t-smooth);
}
.quick-ref-card:hover {
    transform: translateY(-4px) translateZ(0);
    box-shadow: 0 8px 20px rgba(45, 90, 39, 0.1);
}

/* Timer ring smooth stroke transition */
.timer-ring-fill {
    transition: stroke-dashoffset 0.95s cubic-bezier(0.16, 1, 0.3, 1), stroke var(--t-smooth);
}

/* Smooth theme toggle */
body,
header,
.calc-card,
.tab-nav,
.dashboard-widget,
.result-display,
.info-box,
footer {
    transition: background-color var(--t-smooth), border-color var(--t-smooth), color var(--t-smooth);
}

/* Modal entrance - smoother spring */
.confirm-overlay.visible .confirm-card,
#onboarding-overlay.visible .onboarding-card,
#pin-overlay.visible .onboarding-card {
    animation: modalSpring 0.5s cubic-bezier(0.16, 1, 0.3, 1) both;
}

@keyframes modalSpring {
    0%   { opacity: 0; transform: translateY(24px) scale(0.95); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
}

/* Smooth back-to-top */
.back-to-top {
    transition: opacity var(--t-smooth), transform var(--t-bounce), background var(--t-smooth), border-color var(--t-smooth);
}

/* Input focus ring smooth */
input[type="number"],
input[type="text"],
input[type="time"],
select,
textarea {
    transition:
        border-color var(--t-smooth),
        background   var(--t-smooth),
        box-shadow   var(--t-smooth);
}

/* Shift countdown bar smooth */
.cd-fill {
    transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
}

/* Toast notification spring entrance */
.mc-toast.visible {
    animation: toastIn 0.45s cubic-bezier(0.16, 1, 0.3, 1) both;
}

@keyframes toastIn {
    0%   { opacity: 0; transform: translateX(-50%) translateY(16px) scale(0.92); }
    100% { opacity: 1; transform: translateX(-50%) translateY(0) scale(1); }
}

/* Tab active indicator smooth slide feel */
.tab-btn.active {
    transition:
        background   var(--t-smooth),
        color        var(--t-smooth),
        border-color var(--t-smooth);
}

/* Mobile: remove blue flash on ALL tappable elements */
a, button, input, select, textarea, label,
[role="button"], [role="tab"] {
    -webkit-tap-highlight-color: rgba(157, 201, 144, 0.18);
    tap-highlight-color: rgba(157, 201, 144, 0.18);
}

/* Smooth scroll for entire page on iOS */
* {
    -webkit-overflow-scrolling: touch;
}

/* Stagger tab buttons on page load */
.tab-btn:nth-child(1)  { animation-delay: 0ms; }
.tab-btn:nth-child(2)  { animation-delay: 30ms; }
.tab-btn:nth-child(3)  { animation-delay: 60ms; }
.tab-btn:nth-child(4)  { animation-delay: 90ms; }
.tab-btn:nth-child(5)  { animation-delay: 120ms; }
.tab-btn:nth-child(6)  { animation-delay: 150ms; }
.tab-btn:nth-child(7)  { animation-delay: 180ms; }
.tab-btn:nth-child(8)  { animation-delay: 210ms; }
.tab-btn:nth-child(9)  { animation-delay: 240ms; }
.tab-btn:nth-child(10) { animation-delay: 270ms; }
.tab-btn:nth-child(11) { animation-delay: 300ms; }

@keyframes tabFadeIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
}

.tab-btn {
    animation: tabFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
}

/* Respect reduced motion — all at once, no stagger */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        animation-delay: 0ms !important;
    }
    .reveal { opacity: 1; transform: none; }
    .tab-btn { animation: none; }
}
</style>
</head>
<body>

<a class="skip-link" href="#main-content">Skip to main content</a>

<div id="hci-live-region" role="status" aria-live="polite" aria-atomic="true" style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;"></div>

<!-- ==================== SVG ICON DEFINITIONS ==================== -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <symbol id="icon-cross" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 3v18M3 12h18"/>
    </symbol>
    <symbol id="icon-timer" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="13" r="8"/><path d="M12 9v4l2.5 2.5M9 2h6M12 5v-3"/>
    </symbol>
    <symbol id="icon-pill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <rect x="3" y="10" width="18" height="8" rx="4"/><path d="M12 10V18"/>
    </symbol>
    <symbol id="icon-drip" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2C12 2 7 9 7 14a5 5 0 0 0 10 0c0-5-5-12-5-12z"/><circle cx="12" cy="19" r="1" fill="currentColor"/>
    </symbol>
    <symbol id="icon-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
    </symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 3v18h18"/><path d="M7 16l4-6 4 4 4-8"/>
    </symbol>
    <symbol id="icon-baby" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="7" r="4"/><path d="M8 11C5 12 3 15 3 18h18c0-3-2-6-5-7"/>
    </symbol>
    <symbol id="icon-flask" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 2v10L4 20a2 2 0 0 0 1.9 2.6h12.2A2 2 0 0 0 20 20l-5-8V2M8 2h8"/>
    </symbol>
    <symbol id="icon-swap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M7 16V4m0 0L3 8m4-4l4 4"/><path d="M17 8v12m0 0l4-4m-4 4l-4-4"/>
    </symbol>
    <symbol id="icon-book" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
    </symbol>
    <symbol id="icon-syringe" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 2l4 4-10 10H8v-4L18 2z"/><path d="M5 15l-3 3 2 2 3-3M9 9l5 5"/>
    </symbol>
    <symbol id="icon-notes" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 4a2 2 0 0 1 2-2h8l6 6v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4z"/><path d="M14 2v6h6M8 13h8M8 17h5"/>
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
    </symbol>
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
    </symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
    </symbol>
    <symbol id="icon-pin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
    </symbol>
    <symbol id="icon-arrow-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 19V5M5 12l7-7 7 7"/>
    </symbol>
    <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 12h14M12 5l7 7-7 7"/>
    </symbol>
    <symbol id="icon-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
    </symbol>
    <symbol id="icon-route" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="6" cy="19" r="3"/><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"/><circle cx="18" cy="5" r="3"/>
    </symbol>
    <symbol id="icon-chart-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/>
    </symbol>
    <symbol id="icon-leaf" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>
    </symbol>
    <symbol id="icon-warning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
    </symbol>
    <symbol id="icon-hospital" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"/><path d="M9 22V12h6v10"/><path d="M12 8v4M10 10h4"/>
    </symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
    </symbol>
    <symbol id="icon-cancel" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>
    </symbol>
    <symbol id="icon-flag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>
    </symbol>
    <symbol id="icon-muscle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M14.5 10c-.83 0-1.5-.67-1.5-1.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5z"/><path d="M20.5 10H19V8.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/><path d="M9.5 14.5v-5c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5z"/><path d="M3.5 14H5v-1.5c0-.83-.67-1.5-1.5-1.5S2 11.67 2 12.5 2.67 14 3.5 14z"/><path d="M11.5 16.5v-5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5z"/><path d="M3.5 14c.83 0 1.5.67 1.5 1.5S4.33 17 3.5 17 2 16.33 2 15.5 2.67 14 3.5 14z"/>
    </symbol>
    <symbol id="icon-star" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
    </symbol>
    <symbol id="icon-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
    </symbol>
    <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </symbol>
</svg>

<!-- ==================== HEADER ==================== -->
<header role="banner" aria-label="MedConvert application header">
    <div class="header-content">
        <div class="header-top">
            <div class="header-branding">
                <h1>MedConvert</h1>
                <p class="subtitle" id="subtitle-text">An Offline Tool for Abigail</p>
            </div>
            <div class="header-controls">
                <div class="clock-widget">
                    <div class="clock-time" id="clock-time">12:00 PM</div>
                    <div class="clock-date" id="clock-date">Mon, Jan 1</div>
                </div>
                <button class="theme-toggle" id="theme-toggle" title="Toggle dark/light mode" aria-label="Toggle dark mode">
                    <svg><use href="#icon-moon"/></svg>
                </button>
                <div class="offline-badge" id="offline-badge" title="Connectivity status" aria-live="polite">
                    <span class="offline-dot"></span><span class="offline-label">Online</span>
                </div>
                <button class="icon-btn" onclick="openSettings()" title="Settings" aria-label="Open settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/>
                        <circle cx="8" cy="6" r="2" fill="currentColor"/>
                        <circle cx="16" cy="12" r="2" fill="currentColor"/>
                        <circle cx="10" cy="18" r="2" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        <p class="greeting" id="greeting" style="margin-top:0">Good day — ready for your shift?</p>
    </div>
</header>

<!-- ==================== MAIN CONTAINER ==================== -->
<main id="main-content" aria-label="Medical calculators">
<div class="container">

    <!-- Shift Countdown -->
    <div id="shift-countdown" class="shift-countdown"></div>

    <!-- Dashboard Row -->
    <div class="dashboard-collapse-wrap reveal">
        <button class="dashboard-toggle" id="dashboard-toggle" aria-expanded="false" aria-controls="dashboard-row">
            <span class="dashboard-toggle-label">Quick Access &amp; Recent</span>
            <svg class="dashboard-toggle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="dashboard-row" id="dashboard-row" aria-hidden="true">
            <div class="dashboard-widget">
                <div class="widget-title">
                    Quick Access
                    <button class="pin-manage-btn" onclick="openPinManager()">+ Manage</button>
                </div>
                <div id="pinned-tools"></div>
            </div>
            <div class="dashboard-widget">
                <div class="widget-title">Recent Calculations</div>
                <div id="calc-history"></div>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav-wrapper"><nav class="tab-nav reveal" role="tablist" aria-label="Calculator sections">
        <button class="tab-btn active" data-tab="timer" role="tab" aria-selected="true" aria-controls="panel-timer" id="tab-timer" tabindex="0">
            <svg aria-hidden="true" focusable="false"><use href="#icon-timer"/></svg> Timer
        </button>
        <button class="tab-btn" data-tab="dosage" role="tab" aria-selected="false" aria-controls="panel-dosage" id="tab-dosage" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-pill"/></svg> Dosage
        </button>
        <button class="tab-btn" data-tab="iv" role="tab" aria-selected="false" aria-controls="panel-iv" id="tab-iv" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-drip"/></svg> IV &amp; Drip
        </button>
        <button class="tab-btn" data-tab="vitals" role="tab" aria-selected="false" aria-controls="panel-vitals" id="tab-vitals" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-heart"/></svg> Vitals
        </button>
        <button class="tab-btn" data-tab="assessment" role="tab" aria-selected="false" aria-controls="panel-assessment" id="tab-assessment" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-chart"/></svg> Assessment
        </button>
        <button class="tab-btn" data-tab="pediatric" role="tab" aria-selected="false" aria-controls="panel-pediatric" id="tab-pediatric" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-baby"/></svg> Pediatric
        </button>
        <button class="tab-btn" data-tab="lab" role="tab" aria-selected="false" aria-controls="panel-lab" id="tab-lab" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-flask"/></svg> Lab Values
        </button>
        <button class="tab-btn" data-tab="convert" role="tab" aria-selected="false" aria-controls="panel-convert" id="tab-convert" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-swap"/></svg> Converters
        </button>
        <button class="tab-btn" data-tab="reference" role="tab" aria-selected="false" aria-controls="panel-reference" id="tab-reference" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-book"/></svg> Reference
        </button>
        <button class="tab-btn" data-tab="drugs" role="tab" aria-selected="false" aria-controls="panel-drugs" id="tab-drugs" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-syringe"/></svg> Drug Ref
        </button>
        <button class="tab-btn" data-tab="notes" role="tab" aria-selected="false" aria-controls="panel-notes" id="tab-notes" tabindex="-1">
            <svg aria-hidden="true" focusable="false"><use href="#icon-notes"/></svg> Notes
        </button>
    </nav><div class="tab-fade-right" aria-hidden="true"></div></div>

    <!-- ==================== TIMER PANEL ==================== -->
    <div id="panel-timer" class="calc-card active" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon">
                <svg><use href="#icon-timer"/></svg>
            </div>
            <div>
                <h2 class="card-title">Vitals Timer</h2>
                <p class="card-subtitle">Quick timing for monitoring intervals and procedures</p>
            </div>
        </div>

        <div class="timer-label-wrap">
            <input type="text" id="timer-label-input" class="timer-label-field" placeholder="What are you timing? e.g. BP re-check" maxlength="40" autocomplete="off">
        </div>
        <div class="timer-display">
            <div class="timer-ring-wrap">
                <svg class="timer-ring" viewBox="0 0 120 120" aria-hidden="true">
                    <circle class="timer-ring-bg" cx="60" cy="60" r="52" fill="none" stroke-width="6"/>
                    <circle class="timer-ring-fill" id="timer-ring-fill" cx="60" cy="60" r="52" fill="none" stroke-width="6"
                        stroke-dasharray="326.7" stroke-dashoffset="0" stroke-linecap="round"/>
                </svg>
                <div class="timer-ring-inner">
                    <div class="timer-countdown" id="timer-countdown">00</div>
                    <div class="timer-label">remaining</div>
                </div>
            </div>
        </div>

        <h4 style="margin-bottom:var(--space-4);color:var(--text-secondary);font-family:var(--font-body);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.06em;">Quick Presets</h4>
        <div class="timer-presets">
            <button class="timer-btn" onclick="startTimer(15)"><span class="timer-time">15s</span><span class="timer-desc">Pulse count</span></button>
            <button class="timer-btn" onclick="startTimer(30)"><span class="timer-time">30s</span><span class="timer-desc">Resp. rate</span></button>
            <button class="timer-btn" onclick="startTimer(60)"><span class="timer-time">1 min</span><span class="timer-desc">Full assessment</span></button>
            <button class="timer-btn" onclick="startTimer(120)"><span class="timer-time">2 min</span><span class="timer-desc">Nebulizer</span></button>
            <button class="timer-btn" onclick="startTimer(300)"><span class="timer-time">5 min</span><span class="timer-desc">BP re-check</span></button>
            <button class="timer-btn" onclick="startTimer(600)"><span class="timer-time">10 min</span><span class="timer-desc">Obs interval</span></button>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>Custom Duration (seconds)</label>
                <input type="number" inputmode="decimal" id="custom-timer-input" placeholder="e.g., 90" min="1">
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="startCustomTimer()">
                <svg><use href="#icon-timer"/></svg> Start Timer
            </button>
            <button class="btn btn-secondary" onclick="resetTimer()">
                <svg><use href="#icon-cancel"/></svg> Reset
            </button>
        </div>
    </div>

    <!-- ==================== DOSAGE PANEL ==================== -->
    <div id="panel-dosage" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-pill"/></svg></div>
            <div>
                <h2 class="card-title">Dosage Calculators</h2>
                <p class="card-subtitle">Standard formula, weight-based, and BSA dosing</p>
            </div>
        </div>

        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('dosage-standard')">Standard D/H×Q</button>
            <button class="sub-tab" onclick="showSubPanel('dosage-weight')">Weight-Based</button>
            <button class="sub-tab" onclick="showSubPanel('dosage-bsa')">BSA</button>
        </div>

        <!-- Standard Dosage -->
        <div id="sub-dosage-standard" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Standard Formula: D/H × Q</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Desired Dose (D)</label>
                    <input type="number" inputmode="decimal" id="dose-desired" placeholder="e.g., 500" step="0.01">
                </div>
                <div class="form-group">
                    <label>Dose on Hand (H)</label>
                    <input type="number" inputmode="decimal" id="dose-stock" placeholder="e.g., 250" step="0.01">
                </div>
                <div class="form-group">
                    <label>Quantity / Volume (Q, mL)</label>
                    <input type="number" inputmode="decimal" id="dose-volume" placeholder="e.g., 5" step="0.1">
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateDosage()">Calculate Volume to Administer</button>
            <div class="result-display" id="dosage-result">
                <div class="result-label">Volume to Administer</div>
                <div class="result-value" id="dosage-result-value">0 mL</div>
                <div class="result-note">Double-check using the five rights before administration.</div>
            </div>
            <div class="info-box">
                <p><strong>Formula:</strong> Volume = (Desired Dose ÷ Dose on Hand) × Quantity</p>
                <p style="margin-top:0.5rem;">Verify the drug concentration on the medication label before calculating.</p>
            </div>
        </div>

        <!-- Weight-Based -->
        <div id="sub-dosage-weight" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Weight-Based Dosing</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Patient Weight
                        <span class="unit-toggle-group" role="group" aria-label="Weight unit">
                            <button type="button" class="unit-toggle-btn active" data-unit="kg" onclick="setWeightUnit(this,'weight-dose-kg')">kg</button>
                            <button type="button" class="unit-toggle-btn" data-unit="lbs" onclick="setWeightUnit(this,'weight-dose-kg')">lbs</button>
                        </span>
                    </label>
                    <input type="number" inputmode="decimal" id="weight-dose-kg" placeholder="e.g., 70" step="0.1" data-unit="kg">
                </div>
                <div class="form-group">
                    <label>Dose per kg (mg/kg)</label>
                    <input type="number" inputmode="decimal" id="weight-dose-per-kg" placeholder="e.g., 10" step="0.01">
                </div>
                <div class="form-group">
                    <label>Frequency per day</label>
                    <select id="weight-dose-freq">
                        <option value="1">Once daily</option>
                        <option value="2">Twice daily (BID)</option>
                        <option value="3">Three times daily (TID)</option>
                        <option value="4">Four times daily (QID)</option>
                        <option value="6">Every 4 hours</option>
                        <option value="8">Every 3 hours</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateWeightDose()">Calculate Dose</button>
            <div class="result-display" id="weight-dose-result">
                <div class="result-label">Dose per Administration</div>
                <div class="result-value" id="weight-dose-value">0 mg</div>
                <div class="result-note" id="weight-dose-note"></div>
            </div>
        </div>

        <!-- BSA -->
        <div id="sub-dosage-bsa" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Body Surface Area Dosing (Mosteller)</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Height (cm)</label>
                    <input type="number" inputmode="decimal" id="bsa-height" placeholder="e.g., 170" step="0.1">
                </div>
                <div class="form-group">
                    <label>Weight
                        <span class="unit-toggle-group" role="group" aria-label="Weight unit">
                            <button type="button" class="unit-toggle-btn active" data-unit="kg" onclick="setWeightUnit(this,'bsa-weight')">kg</button>
                            <button type="button" class="unit-toggle-btn" data-unit="lbs" onclick="setWeightUnit(this,'bsa-weight')">lbs</button>
                        </span>
                    </label>
                    <input type="number" inputmode="decimal" id="bsa-weight" placeholder="e.g., 70" step="0.1" data-unit="kg">
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateBSA()">Calculate BSA</button>
            <div class="result-display" id="bsa-result">
                <div class="result-label">Body Surface Area</div>
                <div class="result-value" id="bsa-value">0 m²</div>
                <div class="result-note">Used for chemotherapy and critical medication dosing.</div>
            </div>
            <div class="form-group mt-lg">
                <label>Dose per m² (optional)</label>
                <input type="number" inputmode="decimal" id="bsa-dose-per-m2" placeholder="e.g., 40" step="0.01">
            </div>
            <button class="btn btn-secondary btn-full" onclick="calculateBSADose()">Calculate BSA-Based Dose</button>
            <div class="result-display" id="bsa-dose-result">
                <div class="result-label">Total Dose</div>
                <div class="result-value" id="bsa-dose-value">0 mg</div>
            </div>
            <div class="info-box">
                <p><strong>Mosteller Formula:</strong> BSA (m²) = &#8730;[(Height × Weight) ÷ 3600]</p>
                <p style="margin-top:0.5rem;">Most accurate for oncology and high-risk medications.</p>
            </div>
        </div>
    </div>

    <!-- ==================== IV & DRIP PANEL ==================== -->
    <div id="panel-iv" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-drip"/></svg></div>
            <div>
                <h2 class="card-title">IV &amp; Drip Calculators</h2>
                <p class="card-subtitle">Flow rates, infusion times, and concentration calculations</p>
            </div>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('drip-rate')">Drip Rate</button>
            <button class="sub-tab" onclick="showSubPanel('infusion-time')">Infusion Time</button>
            <button class="sub-tab" onclick="showSubPanel('concentration')">Concentration</button>
        </div>

        <div id="sub-drip-rate" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">IV Drip Rate</h3>
            <div class="form-row">
                <div class="form-group"><label>Total Volume (mL)</label><input type="number" inputmode="decimal" id="iv-volume" placeholder="e.g., 1000" step="1"></div>
                <div class="form-group"><label>Time (minutes)</label><input type="number" inputmode="decimal" id="iv-time" placeholder="e.g., 480" step="1"></div>
                <div class="form-group">
                    <label>Drop Factor (gtt/mL)</label>
                    <select id="iv-gtt">
                        <option value="10">10 gtt/mL (Macro)</option>
                        <option value="15">15 gtt/mL (Macro)</option>
                        <option value="20" selected>20 gtt/mL (Macro)</option>
                        <option value="60">60 gtt/mL (Micro)</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateIV()">Calculate Rate</button>
            <div class="result-display" id="iv-result">
                <div class="result-label">Drip Rate</div>
                <div class="result-value" id="iv-result-value">0 gtt/min</div>
                <div class="result-note" id="iv-result-note"></div>
                <div class="result-interpretation" id="iv-ml-hr"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> Drops/min = (Volume × Drop Factor) ÷ Time in Minutes<br><br><strong>Verification tip:</strong> Count drops for 15 seconds and multiply by 4.</p></div>
        </div>

        <div id="sub-infusion-time" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Infusion Time Calculator</h3>
            <div class="form-row">
                <div class="form-group"><label>Total Volume (mL)</label><input type="number" inputmode="decimal" id="infusion-volume" placeholder="e.g., 1000" step="1"></div>
                <div class="form-group"><label>Flow Rate (mL/hr)</label><input type="number" inputmode="decimal" id="infusion-rate" placeholder="e.g., 125" step="1"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateInfusionTime()">Calculate Time</button>
            <div class="result-display" id="infusion-time-result">
                <div class="result-label">Infusion Duration</div>
                <div class="result-value" id="infusion-time-value">0 hours</div>
                <div class="result-note" id="infusion-completion"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> Time (hours) = Volume (mL) ÷ Rate (mL/hr)</p></div>
        </div>

        <div id="sub-concentration" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">IV Concentration Calculator</h3>
            <div class="form-row">
                <div class="form-group"><label>Drug Amount</label><input type="number" inputmode="decimal" id="conc-drug" placeholder="e.g., 400" step="0.01"></div>
                <div class="form-group"><label>Total Volume (mL)</label><input type="number" inputmode="decimal" id="conc-volume" placeholder="e.g., 250" step="1"></div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="conc-unit"><option value="mg">mg</option><option value="mcg">mcg</option><option value="units">units</option></select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateConcentration()">Calculate Concentration</button>
            <div class="result-display" id="concentration-result">
                <div class="result-label">Concentration</div>
                <div class="result-value" id="concentration-value">0 mg/mL</div>
                <div class="result-note">Use this to verify medication preparations.</div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> Concentration = Drug Amount ÷ Total Volume<br><br><strong>Example:</strong> 400 mg Dopamine in 250 mL = 1.6 mg/mL</p></div>
        </div>
    </div>

    <!-- ==================== VITALS PANEL ==================== -->
    <div id="panel-vitals" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-heart"/></svg></div>
            <div>
                <h2 class="card-title">Vital Signs Calculators</h2>
                <p class="card-subtitle">Blood pressure, oxygen, and cardiac calculations</p>
            </div>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('map')">MAP</button>
            <button class="sub-tab" onclick="showSubPanel('pp')">Pulse Pressure</button>
            <button class="sub-tab" onclick="showSubPanel('shock-index')">Shock Index</button>
            <button class="sub-tab" onclick="showSubPanel('a-a-gradient')">A-a Gradient</button>
        </div>

        <div id="sub-map" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Mean Arterial Pressure</h3>
            <div class="form-row">
                <div class="form-group"><label>Systolic BP (mmHg)</label><input type="number" inputmode="decimal" id="bp-sys" placeholder="e.g., 120" step="1"></div>
                <div class="form-group"><label>Diastolic BP (mmHg)</label><input type="number" inputmode="decimal" id="bp-dia" placeholder="e.g., 80" step="1"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateMAP()">Calculate MAP</button>
            <div class="result-display" id="map-result">
                <div class="result-label">Mean Arterial Pressure</div>
                <div class="result-value" id="map-value">0 mmHg</div>
                <div class="result-note" id="map-interpretation"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> MAP = DBP + (1/3) × (SBP – DBP)<br><br><strong>Target:</strong> MAP &gt; 65 mmHg for adequate organ perfusion.</p></div>
        </div>

        <div id="sub-pp" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Pulse Pressure</h3>
            <div class="form-row">
                <div class="form-group"><label>Systolic BP (mmHg)</label><input type="number" inputmode="decimal" id="pp-sys" placeholder="e.g., 120" step="1"></div>
                <div class="form-group"><label>Diastolic BP (mmHg)</label><input type="number" inputmode="decimal" id="pp-dia" placeholder="e.g., 80" step="1"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculatePP()">Calculate Pulse Pressure</button>
            <div class="result-display" id="pp-result">
                <div class="result-label">Pulse Pressure</div>
                <div class="result-value" id="pp-value">0 mmHg</div>
                <div class="result-note" id="pp-note"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> PP = Systolic – Diastolic<br><br><strong>Normal:</strong> 40 mmHg. Narrow &lt;25 or wide &gt;60 may indicate pathology.</p></div>
        </div>

        <div id="sub-shock-index" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Shock Index</h3>
            <div class="form-row">
                <div class="form-group"><label>Heart Rate (bpm)</label><input type="number" inputmode="decimal" id="si-hr" placeholder="e.g., 90" step="1"></div>
                <div class="form-group"><label>Systolic BP (mmHg)</label><input type="number" inputmode="decimal" id="si-sbp" placeholder="e.g., 110" step="1"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateShockIndex()">Calculate Shock Index</button>
            <div class="result-display" id="si-result">
                <div class="result-label">Shock Index</div>
                <div class="result-value" id="si-value">0</div>
                <div class="result-note" id="si-note"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> SI = Heart Rate ÷ Systolic BP<br><br>&lt;0.6 = Normal. 0.6–1.0 = Mild. &gt;1.0 = Moderate/Severe shock risk.</p></div>
        </div>

        <div id="sub-a-a-gradient" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">A-a Oxygen Gradient</h3>
            <div class="form-row">
                <div class="form-group"><label>FiO&#8322; (%)</label><input type="number" inputmode="decimal" id="aa-fio2" placeholder="e.g., 21" step="1" min="21" max="100"></div>
                <div class="form-group"><label>PaCO&#8322; (mmHg)</label><input type="number" inputmode="decimal" id="aa-paco2" placeholder="e.g., 40" step="0.1"></div>
                <div class="form-group"><label>PaO&#8322; (mmHg)</label><input type="number" inputmode="decimal" id="aa-pao2" placeholder="e.g., 95" step="0.1"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateAAGradient()">Calculate A-a Gradient</button>
            <div class="result-display" id="aa-result">
                <div class="result-label">A-a Gradient</div>
                <div class="result-value" id="aa-value">0 mmHg</div>
                <div class="result-note" id="aa-note"></div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> A-a = [FiO&#8322; × (760–47) – PaCO&#8322;/0.8] – PaO&#8322;<br><br><strong>Normal:</strong> &lt; age/4 + 4 mmHg. Elevated suggests intrinsic lung disease.</p></div>
        </div>
    </div>

    <!-- ==================== ASSESSMENT PANEL ==================== -->
    <div id="panel-assessment" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-chart"/></svg></div>
            <div>
                <h2 class="card-title">Clinical Assessment</h2>
                <p class="card-subtitle">GCS, BMI, eGFR, and Wells DVT score</p>
            </div>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('gcs')">GCS</button>
            <button class="sub-tab" onclick="showSubPanel('bmi')">BMI</button>
            <button class="sub-tab" onclick="showSubPanel('egfr')">eGFR</button>
            <button class="sub-tab" onclick="showSubPanel('wells')">Wells DVT</button>
        </div>

        <div id="sub-gcs" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Glasgow Coma Scale</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Eye Opening (E)</label>
                    <select id="gcs-eye" onchange="calculateGCS()">
                        <option value="4">4 — Spontaneous</option>
                        <option value="3">3 — To voice</option>
                        <option value="2">2 — To pain</option>
                        <option value="1">1 — No response</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Verbal Response (V)</label>
                    <select id="gcs-verbal" onchange="calculateGCS()">
                        <option value="5">5 — Oriented</option>
                        <option value="4">4 — Confused</option>
                        <option value="3">3 — Inappropriate words</option>
                        <option value="2">2 — Incomprehensible</option>
                        <option value="1">1 — No response</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Motor Response (M)</label>
                    <select id="gcs-motor" onchange="calculateGCS()">
                        <option value="6">6 — Obeys commands</option>
                        <option value="5">5 — Localizes pain</option>
                        <option value="4">4 — Withdraws</option>
                        <option value="3">3 — Flexion</option>
                        <option value="2">2 — Extension</option>
                        <option value="1">1 — No response</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateGCS()">Calculate GCS</button>
            <div class="result-display" id="gcs-result">
                <div class="result-label">GCS Total</div>
                <div class="result-value" id="gcs-result-value">0</div>
                <div class="result-note" id="gcs-interpretation"></div>
            </div>
        </div>

        <div id="sub-bmi" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Body Mass Index</h3>
            <div class="form-row">
                <div class="form-group"><label>Height (cm)</label><input type="number" inputmode="decimal" id="bmi-height" placeholder="e.g., 170" step="0.1"></div>
                <div class="form-group">
                    <label>Weight
                        <span class="unit-toggle-group" role="group" aria-label="Weight unit">
                            <button type="button" class="unit-toggle-btn active" data-unit="kg" onclick="setWeightUnit(this,'bmi-weight')">kg</button>
                            <button type="button" class="unit-toggle-btn" data-unit="lbs" onclick="setWeightUnit(this,'bmi-weight')">lbs</button>
                        </span>
                    </label>
                    <input type="number" inputmode="decimal" id="bmi-weight" placeholder="e.g., 70" step="0.1" data-unit="kg">
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateBMI()">Calculate BMI</button>
            <div class="result-display" id="bmi-result">
                <div class="result-label">BMI</div>
                <div class="result-value" id="bmi-result-value">0</div>
                <div class="result-note" id="bmi-category"></div>
            </div>
        </div>

        <div id="sub-egfr" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">eGFR — CKD-EPI 2021 (Race-Neutral)</h3>
            <div class="form-row">
                <div class="form-group"><label>Age (years)</label><input type="number" inputmode="decimal" id="egfr-age" placeholder="e.g., 45" step="1"></div>
                <div class="form-group">
                    <label>Sex</label>
                    <select id="egfr-sex"><option value="male">Male</option><option value="female">Female</option></select>
                </div>
                <div class="form-group"><label>Creatinine (mg/dL)</label><input type="number" inputmode="decimal" id="egfr-cr" placeholder="e.g., 1.0" step="0.01"></div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateEGFR()">Calculate eGFR</button>
            <div class="result-display" id="egfr-result">
                <div class="result-label">eGFR</div>
                <div class="result-value" id="egfr-value">0 mL/min/1.73m²</div>
                <div class="result-interpretation" id="egfr-stage"></div>
            </div>
            <div class="info-box" style="margin-top:var(--space-5);">
                <p><strong>2021 CKD-EPI:</strong> Uses the race-neutral equation, now the clinical standard. The previous 2009 race-adjusted formula has been deprecated by most major guidelines including NIDDK and ASN.</p>
            </div>
        </div>

        <div id="sub-wells" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Wells DVT Score</h3>
            <div class="form-group">
                <label style="margin-bottom:var(--space-4);">Check all that apply:</label>
                <div style="display:flex;flex-direction:column;gap:var(--space-3);">
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-1" onchange="calculateWells()" value="1"> Active cancer (ongoing or within 6 months)</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-2" onchange="calculateWells()" value="1"> Paralysis/paresis or recent plaster cast</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-3" onchange="calculateWells()" value="1"> Bedridden &gt;3 days or surgery within 12 weeks</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-4" onchange="calculateWells()" value="1"> Tenderness along deep venous system</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-5" onchange="calculateWells()" value="1"> Entire leg swollen</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-6" onchange="calculateWells()" value="1"> Calf swelling &gt;3 cm vs asymptomatic side</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-7" onchange="calculateWells()" value="1"> Pitting edema in symptomatic leg only</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-8" onchange="calculateWells()" value="1"> Dilated superficial veins (non-varicose)</label>
                    <label style="text-transform:none;letter-spacing:0;font-weight:500;font-size:var(--text-sm);display:flex;align-items:center;cursor:pointer;"><input type="checkbox" id="wells-9" onchange="calculateWells()" value="-2"> Alternative diagnosis at least as likely as DVT (subtract 2)</label>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateWells()">Calculate Wells Score</button>
            <div class="result-display" id="wells-result">
                <div class="result-label">Wells DVT Score</div>
                <div class="result-value" id="wells-value">0 points</div>
                <div class="result-interpretation" id="wells-interpretation"></div>
            </div>
        </div>
    </div>

    <!-- ==================== PEDIATRIC PANEL ==================== -->
    <div id="panel-pediatric" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-baby"/></svg></div>
            <div>
                <h2 class="card-title">Pediatric Calculators</h2>
                <p class="card-subtitle">Weight estimation, dosing, and APGAR scoring</p>
            </div>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('peds-weight')">Weight Est.</button>
            <button class="sub-tab" onclick="showSubPanel('peds-dose')">Dosing</button>
            <button class="sub-tab" onclick="showSubPanel('apgar')">APGAR</button>
        </div>

        <div id="sub-peds-weight" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Weight Estimation (1–10 yrs)</h3>
            <div class="form-group">
                <label>Age (years)</label>
                <input type="number" inputmode="decimal" id="peds-age" placeholder="e.g., 5" min="1" max="10" step="1">
            </div>
            <button class="btn btn-primary btn-full" onclick="calculatePedsWeight()">Estimate Weight</button>
            <div class="result-display" id="peds-weight-result">
                <div class="result-label">Estimated Weight</div>
                <div class="result-value" id="peds-weight-value">0 kg</div>
                <div class="result-note">Broselow tape or actual weight preferred when available.</div>
            </div>
            <div class="info-box"><p><strong>Formula:</strong> Weight (kg) = (Age × 2) + 8</p></div>
        </div>

        <div id="sub-peds-dose" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Pediatric Dosing</h3>
            <div class="form-row">
                <div class="form-group"><label>Weight (kg)</label><input type="number" inputmode="decimal" id="peds-dose-weight" placeholder="e.g., 20" step="0.1"></div>
                <div class="form-group">
                    <label>Medication</label>
                    <select id="peds-medication">
                        <option value="">Select medication...</option>
                        <option value="acetaminophen">Acetaminophen</option>
                        <option value="ibuprofen">Ibuprofen</option>
                        <option value="amoxicillin">Amoxicillin</option>
                        <option value="azithromycin">Azithromycin</option>
                        <option value="ceftriaxone">Ceftriaxone</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculatePedsDose()">Calculate Dose</button>
            <div class="result-display" id="peds-dose-result">
                <div class="result-label">Pediatric Dose</div>
                <div class="result-value" id="peds-dose-value">—</div>
                <div class="result-note" id="peds-dose-note"></div>
            </div>
            <div class="info-box"><p><strong>Clinical Reminder:</strong> Always verify against your institution's formulary. These doses are estimates — weight, renal function, and clinical context must guide final dosing.</p></div>
        </div>

        <div id="sub-apgar" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">APGAR Score</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Appearance (skin color)</label>
                    <select id="apgar-appearance" onchange="calculateAPGAR()"><option value="0">0 — Blue/pale all over</option><option value="1">1 — Blue extremities, pink body</option><option value="2">2 — Completely pink</option></select>
                </div>
                <div class="form-group">
                    <label>Pulse (heart rate)</label>
                    <select id="apgar-pulse" onchange="calculateAPGAR()"><option value="0">0 — Absent</option><option value="1">1 — Below 100</option><option value="2">2 — Above 100</option></select>
                </div>
                <div class="form-group">
                    <label>Grimace (reflex irritability)</label>
                    <select id="apgar-grimace" onchange="calculateAPGAR()"><option value="0">0 — No response</option><option value="1">1 — Grimace</option><option value="2">2 — Cry/cough/sneeze</option></select>
                </div>
                <div class="form-group">
                    <label>Activity (muscle tone)</label>
                    <select id="apgar-activity" onchange="calculateAPGAR()"><option value="0">0 — Limp</option><option value="1">1 — Some flexion</option><option value="2">2 — Active motion</option></select>
                </div>
                <div class="form-group">
                    <label>Respiration</label>
                    <select id="apgar-respiration" onchange="calculateAPGAR()"><option value="0">0 — Absent</option><option value="1">1 — Slow/irregular</option><option value="2">2 — Good cry</option></select>
                </div>
            </div>
            <button class="btn btn-primary btn-full" onclick="calculateAPGAR()">Calculate APGAR</button>
            <div class="result-display" id="apgar-result">
                <div class="result-label">APGAR Score</div>
                <div class="result-value" id="apgar-value">0 / 10</div>
                <div class="result-interpretation" id="apgar-interpretation"></div>
            </div>
        </div>
    </div>

    <!-- ==================== LAB VALUES PANEL ==================== -->
    <div id="panel-lab" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-flask"/></svg></div>
            <div>
                <h2 class="card-title">Lab Value Converter</h2>
                <p class="card-subtitle">Convert between conventional and SI units</p>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label>Lab Test</label>
                <select id="lab-type">
                    <option value="glucose">Glucose</option>
                    <option value="cholesterol">Total Cholesterol</option>
                    <option value="hdl">HDL Cholesterol</option>
                    <option value="ldl">LDL Cholesterol</option>
                    <option value="triglycerides">Triglycerides</option>
                    <option value="creatinine">Creatinine</option>
                    <option value="bun">BUN (Urea)</option>
                    <option value="calcium">Calcium</option>
                    <option value="magnesium">Magnesium</option>
                    <option value="phosphate">Phosphate</option>
                    <option value="bilirubin">Bilirubin</option>
                </select>
            </div>
            <div class="form-group"><label>Value</label><input type="number" inputmode="decimal" id="lab-value" placeholder="Enter lab value" step="0.01"></div>
            <div class="form-group">
                <label>Converting from</label>
                <select id="lab-unit-system"><option value="conventional">Conventional → SI</option><option value="si">SI → Conventional</option></select>
            </div>
        </div>
        <button class="btn btn-primary btn-full" onclick="convertLab()">Convert Units</button>
        <div class="result-display" id="lab-result">
            <div class="result-label">Converted Value</div>
            <div class="result-value" id="lab-result-value">—</div>
            <div class="result-note" id="lab-normal-range"></div>
        </div>
    </div>

    <!-- ==================== CONVERTERS PANEL ==================== -->
    <div id="panel-convert" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-swap"/></svg></div>
            <div>
                <h2 class="card-title">Unit Converters</h2>
                <p class="card-subtitle">Real-time weight, temperature, and height conversions</p>
            </div>
        </div>

        <div style="margin-bottom:var(--space-8);">
            <h4 style="font-family:var(--font-body);color:var(--text-secondary);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.06em;font-weight:700;margin-bottom:var(--space-5);">Weight</h4>
            <div class="converter-live">
                <div class="form-group"><label>Pounds (lbs)</label><input type="number" inputmode="decimal" id="weight-lbs" placeholder="lbs" step="0.01"></div>
                <div class="converter-arrow"><svg><use href="#icon-arrow-right"/></svg></div>
                <div class="form-group"><label>Kilograms (kg)</label><input type="number" inputmode="decimal" id="weight-kg" placeholder="kg" step="0.01"></div>
            </div>
        </div>

        <div style="margin-bottom:var(--space-8);">
            <h4 style="font-family:var(--font-body);color:var(--text-secondary);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.06em;font-weight:700;margin-bottom:var(--space-5);">Temperature</h4>
            <div class="converter-live">
                <div class="form-group"><label>Celsius (&#176;C)</label><input type="number" inputmode="decimal" id="temp-celsius" placeholder="°C" step="0.1"></div>
                <div class="converter-arrow"><svg><use href="#icon-arrow-right"/></svg></div>
                <div class="form-group"><label>Fahrenheit (&#176;F)</label><input type="number" inputmode="decimal" id="temp-fahrenheit" placeholder="°F" step="0.1"></div>
            </div>
        </div>

        <div>
            <h4 style="font-family:var(--font-body);color:var(--text-secondary);font-size:var(--text-xs);text-transform:uppercase;letter-spacing:0.06em;font-weight:700;margin-bottom:var(--space-5);">Height</h4>
            <div class="converter-live">
                <div class="form-group">
                    <label>Feet / Inches</label>
                    <div style="display:flex;gap:var(--space-3);">
                        <input type="number" inputmode="decimal" id="height-feet" placeholder="ft" style="flex:1" step="1">
                        <input type="number" inputmode="decimal" id="height-inches" placeholder="in" style="flex:1" step="0.1">
                    </div>
                </div>
                <div class="converter-arrow"><svg><use href="#icon-arrow-right"/></svg></div>
                <div class="form-group"><label>Centimetres (cm)</label><input type="number" inputmode="decimal" id="height-cm" placeholder="cm" step="0.1"></div>
            </div>
        </div>
    </div>

    <!-- ==================== REFERENCE PANEL ==================== -->
    <div id="panel-reference" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-book"/></svg></div>
            <div>
                <h2 class="card-title">Quick Reference</h2>
                <p class="card-subtitle">Normal lab values, ABG interpretation, and clinical reference</p>
            </div>
        </div>
        <div class="sub-tabs">
            <button class="sub-tab active" onclick="showSubPanel('ref-labs')">Lab Normals</button>
            <button class="sub-tab" onclick="showSubPanel('ref-abg')">ABG Guide</button>
        </div>

        <div id="sub-ref-labs" class="sub-panel active">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Common Lab Normal Values</h3>
            <table class="reference-table">
                <thead><tr><th>Test</th><th>Conventional</th><th>SI Units</th></tr></thead>
                <tbody>
                    <tr><td>Haemoglobin (M)</td><td>13.5–17.5 g/dL</td><td>135–175 g/L</td></tr>
                    <tr><td>Haemoglobin (F)</td><td>12.0–15.5 g/dL</td><td>120–155 g/L</td></tr>
                    <tr><td>WBC Count</td><td>4.5–11.0 × 10³/µL</td><td>4.5–11.0 × 10⁹/L</td></tr>
                    <tr><td>Platelets</td><td>150–400 × 10³/µL</td><td>150–400 × 10⁹/L</td></tr>
                    <tr><td>Sodium</td><td>135–145 mEq/L</td><td>135–145 mmol/L</td></tr>
                    <tr><td>Potassium</td><td>3.5–5.0 mEq/L</td><td>3.5–5.0 mmol/L</td></tr>
                    <tr><td>Creatinine (M)</td><td>0.7–1.3 mg/dL</td><td>62–115 µmol/L</td></tr>
                    <tr><td>Creatinine (F)</td><td>0.6–1.1 mg/dL</td><td>53–97 µmol/L</td></tr>
                    <tr><td>Total Cholesterol</td><td>&lt;200 mg/dL</td><td>&lt;5.2 mmol/L</td></tr>
                    <tr><td>Triglycerides</td><td>&lt;150 mg/dL</td><td>&lt;1.7 mmol/L</td></tr>
                    <tr><td>INR</td><td>0.8–1.2</td><td>—</td></tr>
                </tbody>
            </table>
        </div>

        <div id="sub-ref-abg" class="sub-panel">
            <h3 class="card-subtitle mb-md" style="color:var(--text-primary);font-weight:600;margin-bottom:var(--space-5);">Arterial Blood Gas Normal Values</h3>
            <div class="quick-ref-grid">
                <div class="quick-ref-card"><div class="quick-ref-title">pH</div><div class="quick-ref-value">7.35–7.45</div></div>
                <div class="quick-ref-card"><div class="quick-ref-title">PaCO&#8322;</div><div class="quick-ref-value">35–45 mmHg</div></div>
                <div class="quick-ref-card"><div class="quick-ref-title">PaO&#8322;</div><div class="quick-ref-value">80–100 mmHg</div></div>
                <div class="quick-ref-card"><div class="quick-ref-title">HCO&#8323;&#8315;</div><div class="quick-ref-value">22–26 mEq/L</div></div>
                <div class="quick-ref-card"><div class="quick-ref-title">SaO&#8322;</div><div class="quick-ref-value">95–100%</div></div>
                <div class="quick-ref-card"><div class="quick-ref-title">Base Excess</div><div class="quick-ref-value">&#177;2 mEq/L</div></div>
            </div>
            <h3 class="card-subtitle mt-lg mb-md" style="color:var(--text-primary);font-weight:600;margin:var(--space-8) 0 var(--space-5);">ABG Interpretation Guide</h3>
            <table class="reference-table">
                <thead><tr><th>Disorder</th><th>pH</th><th>PaCO&#8322;</th><th>HCO&#8323;&#8315;</th></tr></thead>
                <tbody>
                    <tr><td>Respiratory Acidosis</td><td>&#8595;</td><td>&#8593;</td><td>Normal/&#8593;</td></tr>
                    <tr><td>Respiratory Alkalosis</td><td>&#8593;</td><td>&#8595;</td><td>Normal/&#8595;</td></tr>
                    <tr><td>Metabolic Acidosis</td><td>&#8595;</td><td>Normal/&#8595;</td><td>&#8595;</td></tr>
                    <tr><td>Metabolic Alkalosis</td><td>&#8593;</td><td>Normal/&#8593;</td><td>&#8593;</td></tr>
                </tbody>
            </table>
            <div class="info-box">
                <p><strong>Quick ABG Steps:</strong></p>
                <p style="margin-top:0.5rem;">
                    1. Check pH: &lt;7.35 = acidosis, &gt;7.45 = alkalosis<br>
                    2. PaCO&#8322; matches pH direction = respiratory cause<br>
                    3. HCO&#8323;&#8315; matches pH direction = metabolic cause<br>
                    4. If other value is also abnormal = compensation<br>
                    5. Calculate A-a gradient if patient is hypoxaemic
                </p>
            </div>
        </div>
    </div>

    <!-- ==================== DRUG REFERENCE PANEL ==================== -->
    <div id="panel-drugs" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-syringe"/></svg></div>
            <div>
                <h2 class="card-title">Drug Reference</h2>
                <p class="card-subtitle">Quick-lookup for 26 common medications — doses, routes, onset, and clinical notes</p>
            </div>
        </div>

        <div class="drug-search-row">
            <input type="text" id="drug-search" placeholder="Search by name, category, or keyword..." oninput="searchDrugs()">
            <button class="btn btn-secondary" onclick="clearDrugSearch()">
                <svg><use href="#icon-cancel"/></svg> Clear
            </button>
        </div>

        <div class="drug-filter-row">
            <select id="drug-category-filter" onchange="searchDrugs()">
                <option value="">All Categories</option>
            </select>
            <span class="drug-count" id="drug-count" aria-live="polite">26 drugs</span>
        </div>

        <div id="drug-results">
            <div class="drug-placeholder">Search by name, category (e.g. "Vasopressor"), or keyword (e.g. "septic shock") to find what you need.</div>
        </div>

        <div class="info-box" style="margin-top:var(--space-8);">
            <p>
                <svg style="width:1rem;height:1rem;vertical-align:middle;margin-right:0.3em;display:inline;flex-shrink:0;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                <strong>Clinical Reminder:</strong> Always verify doses against your institution's formulary and current clinical guidelines. This reference is for quick recall only — not a substitute for professional judgment.
            </p>
        </div>
    </div>

    <!-- ==================== NOTES PANEL ==================== -->
    <div id="panel-notes" class="calc-card" role="tabpanel">
        <div class="card-header">
            <div class="card-header-icon"><svg><use href="#icon-notes"/></svg></div>
            <div>
                <h2 class="card-title">Quick Notes</h2>
                <p class="card-subtitle">Your notes are saved automatically and stored locally on your device</p>
            </div>
        </div>

        <textarea id="shift-notes" placeholder="Start typing your shift notes here...

Use this space for:
  Patient details and observations
  Medication schedules
  Important reminders
  Shift handover notes
  Quick calculation backups

Everything is saved automatically and never leaves your device."></textarea>

        <div class="btn-group mt-lg">
            <button class="btn btn-accent" onclick="clearNotes()">
                <svg><use href="#icon-trash"/></svg> Clear All
            </button>
            <button class="btn btn-secondary" onclick="exportNotes()">
                <svg><use href="#icon-download"/></svg> Export Notes
            </button>
        </div>

        <div class="info-box">
            <p><strong>Privacy Notice:</strong> All notes are stored locally on your device using browser storage. They are never sent to any server and remain completely private. Notes persist even when offline.</p>
        </div>
    </div>

</div><!-- end .container -->
</main><!-- end main#main-content -->

<!-- ==================== FOOTER ==================== -->
<footer role="contentinfo">
    <div class="footer-inner">
        <div class="footer-daily-section">
            <p class="footer-daily-label">Daily Reminder</p>
            <div class="daily-message" id="daily-message">Loading your daily message...</div>
        </div>
        <div class="footer-meta">
            <span class="footer-dot-item">Made with care</span>
            <span class="footer-separator">·</span>
            <span class="footer-dot-item">Always available</span>
            <span class="footer-separator">·</span>
            <span class="footer-dot-item">Built for Abigail</span>
        </div>
    </div>
</footer>

<!-- ==================== BACK TO TOP ==================== -->
<button class="back-to-top" id="back-to-top" aria-label="Scroll back to top of page" title="Back to top">
    <svg aria-hidden="true" focusable="false"><use href="#icon-arrow-up"/></svg>
</button>

<script>
/* ==========================================
   MEDCONVERT — Ghibli-Inspired Medical Toolkit
   Complete JavaScript — Fully Functional
   ========================================== */

'use strict';

document.addEventListener('DOMContentLoaded', () => { initializeApp(); });

function initializeApp() {
    checkOnboarding();
    initializeClock();
    initializeTabs();
    initializeConverters();
    initializeTheme();
    loadNotes();
    setGreeting();
    setDailyFooterMessage();
    initializePinnedTools();
    renderCalcHistory();
    initShiftCountdown();
    initBackToTop();
    initScrollReveal();
    initDrugPanel();
    registerServiceWorker();
}

/* ==================== PROFILE STORE ==================== */
function getProfile() {
    try { const r = localStorage.getItem('medconvert_profile'); return r ? JSON.parse(r) : null; }
    catch { return null; }
}

function saveProfile(p) {
    try { localStorage.setItem('medconvert_profile', JSON.stringify(p)); } catch {}
}

function getName() {
    const p = getProfile();
    return p ? p.name : 'Abigail';
}

/* ==================== THEME ==================== */
function initializeTheme() {
    const saved = localStorage.getItem('medconvert_theme') || 'light';
    applyTheme(saved);
    document.getElementById('theme-toggle').addEventListener('click', () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        applyTheme(next);
        localStorage.setItem('medconvert_theme', next);
    });
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const btn = document.getElementById('theme-toggle');
    if (!btn) return;
    btn.innerHTML = theme === 'dark'
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>';
    btn.title = theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode';
}

/* ==================== ONBOARDING ==================== */
function checkOnboarding() {
    if (!getProfile()) showOnboarding();
    else applyProfileData();
}

function buildOnboardingHTML(profile) {
    const p = profile || {};
    const isEdit = !!profile;
    const iconSVG = isEdit
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 3.6-7 8-7s8 3 8 7"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9z"/><path d="M9 22V12h6v10"/><path d="M12 8v4M10 10h4"/></svg>';
    return `
        <div class="onboarding-card">
            <div class="onboarding-logo">${iconSVG}</div>
            <h2 class="onboarding-title">${isEdit ? 'Your Settings' : 'Welcome to MedConvert'}</h2>
            <p class="onboarding-subtitle">${isEdit ? 'Update your profile anytime.' : "Let's personalise your experience — it only takes a moment."}</p>
            <div class="onboarding-field">
                <label>Your Name</label>
                <input type="text" id="ob-name" value="${p.name || 'Abigail'}" placeholder="e.g. Abigail" autocomplete="off">
            </div>
            <div class="onboarding-field">
                <label>Unit / Specialty</label>
                <select id="ob-specialty">
                    <option value="">Select your unit...</option>
                    ${['ICU','ED','Peds','Med-Surg','OR','Oncology','Cardiology','OB','Other'].map(s => `<option value="${s}"${p.specialty === s ? ' selected' : ''}>${s}</option>`).join('')}
                </select>
            </div>
            <div class="onboarding-field">
                <label>Shift Type</label>
                <div class="shift-picker">
                    <button class="shift-opt${p.shift === 'Day' ? ' selected' : ''}" data-shift="Day" type="button" onclick="selectShift(this)">Days</button>
                    <button class="shift-opt${p.shift === 'Night' ? ' selected' : ''}" data-shift="Night" type="button" onclick="selectShift(this)">Nights</button>
                    <button class="shift-opt${p.shift === 'Rotating' ? ' selected' : ''}" data-shift="Rotating" type="button" onclick="selectShift(this)">Rotating</button>
                </div>
                <input type="hidden" id="ob-shift" value="${p.shift || ''}">
            </div>
            <div class="onboarding-field">
                <label>Shift Hours (for countdown)</label>
                <div class="shift-time-row">
                    <div><span class="time-lbl">Start</span><input type="time" id="ob-shift-start" value="${p.shiftStart || '21:00'}"></div>
                    <span class="time-sep">&#8594;</span>
                    <div><span class="time-lbl">End</span><input type="time" id="ob-shift-end" value="${p.shiftEnd || '06:00'}"></div>
                </div>
            </div>
            ${isEdit
                ? `<div style="display:flex;gap:0.75rem;margin-top:1.5rem;align-items:stretch;">
                    <button class="onboarding-submit" style="flex:1;margin-top:0;" type="button" onclick="submitOnboarding()">Save Changes</button>
                    <button class="onboarding-submit" type="button" style="flex:1;margin-top:0;background:var(--bg-input);color:var(--text-primary);border-color:var(--border);font-weight:600;" onclick="document.getElementById('onboarding-overlay').remove()">Cancel</button>
                   </div>`
                : `<button class="onboarding-submit" type="button" onclick="submitOnboarding()">Get Started</button>`
            }
        </div>`;
}

function showOnboarding() {
    const overlay = document.createElement('div');
    overlay.id = 'onboarding-overlay';
    overlay.innerHTML = buildOnboardingHTML(null);
    document.body.appendChild(overlay);
    requestAnimationFrame(() => { requestAnimationFrame(() => overlay.classList.add('visible')); });
}

window.openSettings = function () {
    const existing = document.getElementById('onboarding-overlay');
    if (existing) existing.remove();
    const overlay = document.createElement('div');
    overlay.id = 'onboarding-overlay';
    overlay.innerHTML = buildOnboardingHTML(getProfile());
    document.body.appendChild(overlay);
    requestAnimationFrame(() => { requestAnimationFrame(() => overlay.classList.add('visible')); });
};

window.selectShift = function (btn) {
    document.querySelectorAll('.shift-opt').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('ob-shift').value = btn.dataset.shift;
};

window.submitOnboarding = function () {
    const name = (document.getElementById('ob-name').value.trim()) || 'there';
    const specialty = document.getElementById('ob-specialty').value || 'General';
    const shift = document.getElementById('ob-shift').value || 'Day';
    const shiftStart = document.getElementById('ob-shift-start').value || '21:00';
    const shiftEnd = document.getElementById('ob-shift-end').value || '06:00';
    saveProfile({ name, specialty, shift, shiftStart, shiftEnd });
    const overlay = document.getElementById('onboarding-overlay');
    overlay.classList.remove('visible');
    overlay.classList.add('hiding');
    setTimeout(() => {
        overlay.remove();
        applyProfileData();
        setGreeting();
        initShiftCountdown();
        setDailyFooterMessage();
    }, 400);
};

function applyProfileData() {
    const p = getProfile();
    if (!p) return;
    const el = document.getElementById('subtitle-text');
    if (el) el.innerHTML = `For ${p.name} &middot; <span class="specialty-badge">${p.specialty}</span>`;
}

/* ==================== SHIFT COUNTDOWN ==================== */
function initShiftCountdown() {
    const p = getProfile();
    const el = document.getElementById('shift-countdown');
    if (!el) return;
    if (!p?.shiftStart || !p?.shiftEnd) { el.style.display = 'none'; return; }

    function update() {
        const now = new Date();
        const [sh, sm] = p.shiftStart.split(':').map(Number);
        const [eh, em] = p.shiftEnd.split(':').map(Number);
        let end = new Date(now); end.setHours(eh, em, 0, 0);
        let start = new Date(now); start.setHours(sh, sm, 0, 0);
        if (end <= start) end.setDate(end.getDate() + 1);

        const inShift = now >= start && now < end;
        if (!inShift) {
            if (now >= end) start.setDate(start.getDate() + 1);
            const diff = start - now;
            const hrs = Math.floor(diff / 3600000), mins = Math.floor((diff % 3600000) / 60000);
            el.innerHTML = `<span class="cd-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="13" r="8"/><path d="M12 9v4l2.5 2.5M9 2h6M12 5v-3"/></svg></span><span class="cd-text">Shift starts in <strong>${hrs}h ${mins}m</strong></span>`;
            el.className = 'shift-countdown cd-pre';
        } else {
            const diff = end - now;
            const hrs = Math.floor(diff / 3600000), mins = Math.floor((diff % 3600000) / 60000);
            const pct = Math.round(((end - start - diff) / (end - start)) * 100);
            const ending = hrs < 2;
            const iconPath = ending
                ? '<path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/>'
                : '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>';
            el.innerHTML = `
                <span class="cd-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${iconPath}</svg></span>
                <span class="cd-text"><strong>${hrs}h ${mins}m</strong> remaining in shift</span>
                <div class="cd-bar"><div class="cd-fill" style="width:${pct}%"></div></div>`;
            el.className = `shift-countdown ${ending ? 'cd-ending' : 'cd-active'}`;
        }
        el.style.display = 'flex';
    }
    update();
    setInterval(update, 60000);
}

/* ==================== PINNED TOOLS ==================== */
const ALL_TABS = [
    { id: 'timer', label: 'Timer', icon: 'icon-timer' },
    { id: 'dosage', label: 'Dosage', icon: 'icon-pill' },
    { id: 'iv', label: 'IV & Drip', icon: 'icon-drip' },
    { id: 'vitals', label: 'Vitals', icon: 'icon-heart' },
    { id: 'assessment', label: 'Assessment', icon: 'icon-chart' },
    { id: 'pediatric', label: 'Pediatric', icon: 'icon-baby' },
    { id: 'lab', label: 'Lab Values', icon: 'icon-flask' },
    { id: 'convert', label: 'Converters', icon: 'icon-swap' },
    { id: 'reference', label: 'Reference', icon: 'icon-book' },
    { id: 'notes', label: 'Notes', icon: 'icon-notes' },
    { id: 'drugs', label: 'Drug Ref', icon: 'icon-syringe' },
];

function getPinned() { try { const r = localStorage.getItem('medconvert_pinned'); return r ? JSON.parse(r) : []; } catch { return []; } }
function savePinned(p) { try { localStorage.setItem('medconvert_pinned', JSON.stringify(p)); } catch {} }
function initializePinnedTools() { renderPinnedSection(); }

function renderPinnedSection() {
    const pinned = getPinned();
    const container = document.getElementById('pinned-tools');
    if (!container) return;
    if (pinned.length === 0) {
        container.innerHTML = `<div class="pinned-empty"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg><span>Pin your most-used tools for quick access</span></div>`;
        return;
    }
    container.innerHTML = `<div class="pinned-grid">
        ${pinned.map(id => {
            const t = ALL_TABS.find(x => x.id === id);
            return t ? `<button class="pinned-btn" onclick="switchToTab('${id}')"><svg><use href="#${t.icon}"/></svg>${t.label}</button>` : '';
        }).join('')}
    </div>`;
}

window.openPinManager = function () {
    const pinned = getPinned();
    const overlay = document.createElement('div');
    overlay.id = 'pin-overlay';
    overlay.innerHTML = `
        <div class="onboarding-card">
            <div class="onboarding-logo">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            </div>
            <h2 class="onboarding-title">Manage Pinned Tools</h2>
            <p class="onboarding-subtitle">Select up to 4 tools to pin for quick access.</p>
            <div class="pin-grid">
                ${ALL_TABS.map(t => `
                    <label class="pin-option${pinned.includes(t.id) ? ' pinned' : ''}">
                        <input type="checkbox" value="${t.id}"${pinned.includes(t.id) ? ' checked' : ''} onchange="togglePin(this)">
                        ${t.label}
                    </label>`).join('')}
            </div>
            <button class="onboarding-submit" type="button" onclick="closePinManager()">Done</button>
        </div>`;
    document.body.appendChild(overlay);
    requestAnimationFrame(() => { requestAnimationFrame(() => overlay.classList.add('visible')); });
};

window.togglePin = function (cb) {
    let pinned = getPinned();
    if (cb.checked) {
        if (pinned.length >= 4) {
            cb.checked = false;
            cb.closest('.pin-option').classList.remove('pinned');
            showToast('Maximum 4 pinned tools', 'warning');
            return;
        }
        pinned.push(cb.value);
        cb.closest('.pin-option').classList.add('pinned');
    } else {
        pinned = pinned.filter(p => p !== cb.value);
        cb.closest('.pin-option').classList.remove('pinned');
    }
    savePinned(pinned);
    renderPinnedSection();
};

window.closePinManager = function () {
    const o = document.getElementById('pin-overlay');
    if (o) { o.classList.remove('visible'); o.classList.add('hiding'); setTimeout(() => o.remove(), 400); }
};

/* ==================== CALCULATION HISTORY ==================== */
function getHistory() { try { const r = localStorage.getItem('medconvert_history'); return r ? JSON.parse(r) : []; } catch { return []; } }

function addToHistory(category, label, value) {
    let h = getHistory();
    h.unshift({ id: Date.now(), category, label, value, time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) });
    h = h.slice(0, 9);
    try { localStorage.setItem('medconvert_history', JSON.stringify(h)); } catch {}
    renderCalcHistory();
}

function renderCalcHistory() {
    const container = document.getElementById('calc-history');
    if (!container) return;
    const h = getHistory();
    if (h.length === 0) {
        container.innerHTML = `<div class="history-empty">No calculations yet — results will appear here</div>`;
        return;
    }
    container.innerHTML = h.slice(0, 3).map(e => `
        <div class="history-item">
            <div class="history-meta">
                <span class="history-cat">${e.category}</span>
                <span class="history-time">${e.time}</span>
            </div>
            <div class="history-label">${e.label}</div>
            <div class="history-value">${e.value}</div>
        </div>`).join('');
}

/* ==================== TOAST ==================== */
function showToast(msg, type = 'info') {
    const ex = document.getElementById('mc-toast');
    if (ex) ex.remove();
    const t = document.createElement('div');
    t.id = 'mc-toast';
    t.className = `mc-toast toast-${type}`;
    t.textContent = msg;
    document.body.appendChild(t);
    requestAnimationFrame(() => { requestAnimationFrame(() => t.classList.add('visible')); });
    setTimeout(() => { t.classList.remove('visible'); setTimeout(() => t.remove(), 350); }, 2800);
}

/* ==================== RESULTS ==================== */
function showResult(resultElId, valueElId, displayValue, status, note, noteElId, interpElId, interpHtml) {
    const resultEl = document.getElementById(resultElId);
    const valueEl = document.getElementById(valueElId);
    if (!resultEl || !valueEl) return;
    valueEl.textContent = displayValue;
    resultEl.classList.remove('result-normal', 'result-warning', 'result-danger', 'result-neutral');
    resultEl.classList.add(`result-${status || 'neutral'}`, 'show');
    if (noteElId && note !== undefined) { const n = document.getElementById(noteElId); if (n) n.textContent = note || ''; }
    if (interpElId && interpHtml !== undefined) { const i = document.getElementById(interpElId); if (i) i.innerHTML = interpHtml || ''; }
    if (navigator.vibrate) navigator.vibrate(12);
}

/* ==================== CLOCK & GREETING ==================== */
function initializeClock() {
    const t = document.getElementById('clock-time'), d = document.getElementById('clock-date');
    function update() {
        const now = new Date();
        if (t) t.textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        if (d) d.textContent = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
    }
    update();
    setInterval(update, 1000);
}

function setGreeting() {
    const h = new Date().getHours(), name = getName(), el = document.getElementById('greeting');
    if (!el) return;
    const msgs = [
        [0, 5, `Still up, baby? I'm proud of you. Go rest soon.`],
        [5, 12, `Good morning, baby. I hope today is kind to you.`],
        [12, 14, `Good afternoon, baby. Have you eaten? Please eat.`],
        [14, 18, `Hey baby, I'm thinking of you. You're doing so well.`],
        [18, 22, `Good evening, baby. Almost through it — I'm waiting for you.`],
        [22, 24, `Night shift again, baby. I made sure this works offline for you.`]
    ];
    el.textContent = (msgs.find(([s, e]) => h >= s && h < e) || msgs[5])[2];
}

function setDailyFooterMessage() {
    const el = document.getElementById('daily-message');
    if (!el) return;
    const name = getName();
    const msgs = [
        `I see how hard you work, ${name}, and I just want you to know — I'm so proud of you. Every single shift.`,
        `I made this for you, ${name}, because you deserve something that makes your job even a little bit easier. I love you.`,
        `I think about you on those long night shifts and I hope you know I'm always rooting for you, ${name}.`,
        `You never complain, you always show up, and you give everything you have. I notice that, ${name}. I really do.`,
        `I wish I could be there with you tonight. Since I can't — I hope this helps. Take care of yourself, ${name}.`,
        `I know the shifts are long and the nights are hard. But I believe in you more than you know, ${name}.`,
        `Please eat, please rest, please drink water. I'm serious, ${name}. You matter so much to me.`,
        `I'm so glad you exist, ${name}. Not just as a nurse — but as you. The world is better with you in it.`,
        `I made sure every calculator here works perfectly, because you deserve tools that don't let you down. Just like you never let anyone down.`,
        `On the days you feel invisible, remember that I see you, ${name}. I always see you.`,
        `I built this offline so it works even at 3am when the signal is gone and you still have patients to care for. I've got you.`,
        `You are my favorite person, ${name}. I just wanted to say that somewhere you'd actually see it.`,
        `I know you're tired. I know. But you're almost there — and I'll be here when you get home.`,
        `Every time you open this app, just know I was thinking of you when I made it, ${name}.`,
        `I love you, ${name}. Go be the amazing nurse I know you are. I'll be here waiting.`
    ];
    const day = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
    el.textContent = msgs[day % msgs.length];
}

/* ==================== NAVIGATION ==================== */
function initializeTabs() {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchToTab(btn.getAttribute('data-tab')));
    });
}

window.switchToTab = function (tabId) {
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-selected', 'false');
    });
    document.querySelectorAll('.calc-card').forEach(p => p.classList.remove('active'));
    const btn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
    const panel = document.getElementById(`panel-${tabId}`);
    if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected', 'true'); }
    if (panel) panel.classList.add('active');
    if (navigator.vibrate) navigator.vibrate(8);
};

window.showSubPanel = function (subId) {
    const clickedBtn = event.currentTarget || event.target;
    const parentCard = clickedBtn.closest('.calc-card');
    if (parentCard) {
        parentCard.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
        parentCard.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
    } else {
        document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
    }
    clickedBtn.classList.add('active');
    const panel = document.getElementById(`sub-${subId}`);
    if (panel) panel.classList.add('active');
    if (navigator.vibrate) navigator.vibrate(5);
};

/* ==================== TIMER ==================== */
let timerInterval = null;

window.startTimer = function (seconds) {
    const display = document.getElementById('timer-countdown');
    if (timerInterval) clearInterval(timerInterval);
    let left = seconds;
    updateTimerDisplay(left);
    timerInterval = setInterval(() => {
        left--;
        updateTimerDisplay(left);
        if (left <= 0) {
            clearInterval(timerInterval);
            display.textContent = 'Done';
            display.style.color = 'var(--dusty-rose)';
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
            showToast('Timer complete', 'success');
        }
    }, 1000);
    if (navigator.vibrate) navigator.vibrate(12);
};

window.startCustomTimer = function () {
    const v = parseInt(document.getElementById('custom-timer-input').value);
    if (v && v > 0) startTimer(v);
    else showToast('Please enter a valid number of seconds', 'warning');
};

function updateTimerDisplay(s) {
    const d = document.getElementById('timer-countdown');
    d.textContent = s >= 60 ? `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}` : s.toString().padStart(2, '0');
    d.style.color = s <= 5 && s > 0 ? 'var(--danger)' : 'var(--forest)';
}

window.resetTimer = function () {
    if (timerInterval) clearInterval(timerInterval);
    const d = document.getElementById('timer-countdown');
    d.textContent = '00';
    d.style.color = 'var(--forest)';
    if (navigator.vibrate) navigator.vibrate(5);
};

/* ==================== DOSAGE ==================== */
window.calculateDosage = function () {
    const D = parseFloat(document.getElementById('dose-desired').value);
    const H = parseFloat(document.getElementById('dose-stock').value);
    const Q = parseFloat(document.getElementById('dose-volume').value);
    if (!D || !H || !Q) { showToast('Please fill in all fields', 'warning'); return; }
    if (H === 0) { showToast('Dose on hand cannot be zero', 'warning'); return; }
    const result = (D / H) * Q;
    const display = `${result.toFixed(2)} mL`;
    showResult('dosage-result', 'dosage-result-value', display, 'neutral');
    addToHistory('Dosage', 'D/H×Q', display);
};

window.calculateWeightDose = function () {
    const w = parseFloat(document.getElementById('weight-dose-kg').value);
    const d = parseFloat(document.getElementById('weight-dose-per-kg').value);
    const f = parseInt(document.getElementById('weight-dose-freq').value) || 1;
    if (!w || !d) { showToast('Please enter weight and dose per kg', 'warning'); return; }
    const single = w * d, daily = single * f;
    const display = `${single.toFixed(1)} mg / dose`;
    showResult('weight-dose-result', 'weight-dose-value', display, 'neutral', `Total daily: ${daily.toFixed(1)} mg (${f}× per day)`, 'weight-dose-note');
    addToHistory('Dosage', 'Weight-based', display);
};

window.calculateBSA = function () {
    const h = parseFloat(document.getElementById('bsa-height').value);
    const w = parseFloat(document.getElementById('bsa-weight').value);
    if (!h || !w) { showToast('Please enter height and weight', 'warning'); return; }
    const bsa = Math.sqrt((h * w) / 3600);
    const display = `${bsa.toFixed(2)} m²`;
    showResult('bsa-result', 'bsa-value', display, 'neutral');
    window.currentBSA = bsa;
    addToHistory('Dosage', 'BSA', display);
};

window.calculateBSADose = function () {
    if (!window.currentBSA) { showToast('Calculate BSA first', 'warning'); return; }
    const d = parseFloat(document.getElementById('bsa-dose-per-m2').value);
    if (!d) { showToast('Enter dose per m²', 'warning'); return; }
    const total = window.currentBSA * d;
    const display = `${total.toFixed(1)} mg`;
    showResult('bsa-dose-result', 'bsa-dose-value', display, 'neutral');
    addToHistory('Dosage', 'BSA Dose', display);
};

/* ==================== IV & DRIP ==================== */
window.calculateIV = function () {
    const vol = parseFloat(document.getElementById('iv-volume').value);
    const time = parseFloat(document.getElementById('iv-time').value);
    const gtt = parseFloat(document.getElementById('iv-gtt').value);
    if (!vol || !time || !gtt) { showToast('Please fill in all fields', 'warning'); return; }
    const rate = (vol * gtt) / time, rounded = Math.round(rate);
    const display = `${rounded} gtt/min`;
    const re = document.getElementById('iv-result');
    document.getElementById('iv-result-value').textContent = display;
    document.getElementById('iv-result-note').textContent = `Count ${Math.round(rate / 4)} drops every 15 seconds`;
    document.getElementById('iv-ml-hr').textContent = `Flow rate: ${Math.round((vol / time) * 60)} mL/hr`;
    re.classList.remove('result-normal', 'result-warning', 'result-danger', 'result-neutral');
    re.classList.add('result-neutral', 'show');
    addToHistory('IV/Drip', 'Drip Rate', display);
    if (navigator.vibrate) navigator.vibrate(12);
};

window.calculateInfusionTime = function () {
    const vol = parseFloat(document.getElementById('infusion-volume').value);
    const rate = parseFloat(document.getElementById('infusion-rate').value);
    if (!vol || !rate) { showToast('Please enter volume and rate', 'warning'); return; }
    const hrs = vol / rate, wh = Math.floor(hrs), mins = Math.round((hrs - wh) * 60);
    const comp = new Date(Date.now() + hrs * 3600000).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    const display = wh > 0 ? `${wh} hr ${mins} min` : `${mins} min`;
    showResult('infusion-time-result', 'infusion-time-value', display, 'neutral', `Completes at approximately ${comp}`, 'infusion-completion');
    addToHistory('IV/Drip', 'Infusion Time', display);
};

window.calculateConcentration = function () {
    const drug = parseFloat(document.getElementById('conc-drug').value);
    const vol = parseFloat(document.getElementById('conc-volume').value);
    const unit = document.getElementById('conc-unit').value;
    if (!drug || !vol) { showToast('Please enter drug amount and volume', 'warning'); return; }
    const conc = drug / vol;
    const display = `${conc.toFixed(3)} ${unit}/mL`;
    showResult('concentration-result', 'concentration-value', display, 'neutral');
    addToHistory('IV/Drip', 'Concentration', display);
};

/* ==================== VITALS ==================== */
window.calculateMAP = function () {
    const sys = parseFloat(document.getElementById('bp-sys').value);
    const dia = parseFloat(document.getElementById('bp-dia').value);
    if (!sys || !dia) { showToast('Please enter both blood pressure values', 'warning'); return; }
    const map = Math.round(dia + (sys - dia) / 3);
    const display = `${map} mmHg`;
    let status = map >= 70 ? 'normal' : map >= 65 ? 'warning' : 'danger';
    let note = map >= 70 ? 'Adequate perfusion pressure' : map >= 65 ? 'Borderline — monitor closely' : 'Below target — consider intervention';
    showResult('map-result', 'map-value', display, status, note, 'map-interpretation');
    addToHistory('Vitals', 'MAP', display);
};

window.calculatePP = function () {
    const sys = parseFloat(document.getElementById('pp-sys').value);
    const dia = parseFloat(document.getElementById('pp-dia').value);
    if (!sys || !dia) { showToast('Please enter both blood pressure values', 'warning'); return; }
    const pp = sys - dia;
    const display = `${pp} mmHg`;
    let status = (pp >= 25 && pp <= 60) ? 'normal' : (pp < 25) ? 'warning' : 'danger';
    let note = pp < 25 ? 'Narrow — consider reduced stroke volume' : pp > 60 ? 'Wide — consider aortic regurgitation or stiff vessels' : 'Normal pulse pressure';
    showResult('pp-result', 'pp-value', display, status, note, 'pp-note');
    addToHistory('Vitals', 'Pulse Pressure', display);
};

window.calculateShockIndex = function () {
    const hr = parseFloat(document.getElementById('si-hr').value);
    const sbp = parseFloat(document.getElementById('si-sbp').value);
    if (!hr || !sbp) { showToast('Please enter heart rate and systolic BP', 'warning'); return; }
    const si = hr / sbp;
    const display = si.toFixed(2);
    let status = si < 0.6 ? 'normal' : si <= 1.0 ? 'warning' : 'danger';
    let note = si < 0.6 ? 'Normal — no haemodynamic compromise' : si <= 1.0 ? 'Mild haemodynamic stress — monitor' : 'Significant haemodynamic compromise — act promptly';
    showResult('si-result', 'si-value', display, status, note, 'si-note');
    addToHistory('Vitals', 'Shock Index', display);
};

window.calculateAAGradient = function () {
    const fio2 = parseFloat(document.getElementById('aa-fio2').value);
    const paco2 = parseFloat(document.getElementById('aa-paco2').value);
    const pao2 = parseFloat(document.getElementById('aa-pao2').value);
    if (!fio2 || !paco2 || !pao2) { showToast('Please fill in all ABG fields', 'warning'); return; }
    const pao2_alveolar = (fio2 / 100) * (760 - 47) - paco2 / 0.8;
    const aa = pao2_alveolar - pao2;
    const normalUpper = 15;
    const display = `${aa.toFixed(1)} mmHg`;
    let status = aa <= normalUpper ? 'normal' : aa <= 35 ? 'warning' : 'danger';
    let note = aa <= normalUpper ? 'Normal gradient — lungs are functioning well' : aa <= 35 ? 'Mildly elevated — possible early lung disease' : 'Significantly elevated — intrinsic lung pathology likely';
    showResult('aa-result', 'aa-value', display, status, note, 'aa-note');
    addToHistory('Vitals', 'A-a Gradient', display);
};

/* ==================== ASSESSMENT ==================== */
window.calculateGCS = function () {
    const e = parseInt(document.getElementById('gcs-eye').value);
    const v = parseInt(document.getElementById('gcs-verbal').value);
    const m = parseInt(document.getElementById('gcs-motor').value);
    const total = e + v + m;
    let status = total >= 13 ? (total >= 15 ? 'normal' : 'warning') : 'danger';
    let label = total === 15 ? 'Fully alert (E' + e + 'V' + v + 'M' + m + ')' : total >= 13 ? 'Minor — (E' + e + 'V' + v + 'M' + m + ')' : total >= 9 ? 'Moderate head injury (E' + e + 'V' + v + 'M' + m + ')' : 'Severe — immediate action required (E' + e + 'V' + v + 'M' + m + ')';
    showResult('gcs-result', 'gcs-result-value', `${total}`, status, label, 'gcs-interpretation');
    addToHistory('Assessment', 'GCS', `${total} pts`);
};

window.calculateBMI = function () {
    const h = parseFloat(document.getElementById('bmi-height').value);
    const w = parseFloat(document.getElementById('bmi-weight').value);
    if (!h || !w || h <= 0 || w <= 0) { showToast('Please enter valid height and weight', 'warning'); return; }
    const bmi = w / Math.pow(h / 100, 2);
    const display = bmi.toFixed(1);
    let status = 'normal', cat = 'Normal weight';
    if (bmi < 18.5) { status = 'warning'; cat = 'Underweight'; }
    else if (bmi >= 30) { status = 'danger'; cat = 'Obese'; }
    else if (bmi >= 25) { status = 'warning'; cat = 'Overweight'; }
    showResult('bmi-result', 'bmi-result-value', display, status, cat, 'bmi-category');
    addToHistory('Assessment', 'BMI', display);
};

window.calculateEGFR = function () {
    const age = parseInt(document.getElementById('egfr-age').value);
    const sex = document.getElementById('egfr-sex').value;
    const cr = parseFloat(document.getElementById('egfr-cr').value);
    if (!age || !cr) { showToast('Please enter age and creatinine', 'warning'); return; }
    const kappa = sex === 'female' ? 0.7 : 0.9, alpha = sex === 'female' ? -0.329 : -0.411;
    const sf = sex === 'female' ? 1.018 : 1.0;
    const egfr = Math.round(141 * Math.pow(Math.min(cr / kappa, 1), alpha) * Math.pow(Math.max(cr / kappa, 1), -1.209) * Math.pow(0.993, age) * sf);
    const display = `${egfr} mL/min/1.73m²`;
    let status = egfr >= 60 ? 'normal' : egfr >= 30 ? 'warning' : 'danger';
    let stage = egfr >= 90 ? '<strong>Stage 1:</strong> Normal or high' : egfr >= 60 ? '<strong>Stage 2:</strong> Mildly decreased' : egfr >= 45 ? '<strong>Stage 3a:</strong> Mild-to-moderate decrease' : egfr >= 30 ? '<strong>Stage 3b:</strong> Moderate-to-severe decrease' : egfr >= 15 ? '<strong>Stage 4:</strong> Severely decreased' : '<strong>Stage 5:</strong> Kidney failure';
    showResult('egfr-result', 'egfr-value', display, status, null, null, 'egfr-stage', stage);
    addToHistory('Assessment', 'eGFR', display);
};

window.calculateWells = function () {
    let score = 0;
    for (let i = 1; i <= 9; i++) {
        const cb = document.getElementById(`wells-${i}`);
        if (cb && cb.checked) score += parseInt(cb.value);
    }
    const display = `${score} points`;
    let status = score <= 0 ? 'normal' : score <= 2 ? 'warning' : 'danger';
    let interp = score <= 0
        ? '<strong>Low Risk:</strong> ~5% probability — D-dimer recommended'
        : score <= 2
            ? '<strong>Moderate Risk:</strong> ~17% probability — D-dimer recommended'
            : '<strong>High Risk:</strong> 17–53% probability — Consider duplex ultrasound';
    showResult('wells-result', 'wells-value', display, status, null, null, 'wells-interpretation', interp);
    addToHistory('Assessment', 'Wells DVT', display);
};

/* ==================== PEDIATRIC ==================== */
window.calculatePedsWeight = function () {
    const age = parseInt(document.getElementById('peds-age').value);
    if (!age || age < 1 || age > 10) { showToast('Enter age between 1 and 10 years', 'warning'); return; }
    const display = `${(age * 2) + 8} kg`;
    showResult('peds-weight-result', 'peds-weight-value', display, 'neutral');
    addToHistory('Pediatric', 'Weight Est.', display);
};

window.calculatePedsDose = function () {
    const w = parseFloat(document.getElementById('peds-dose-weight').value);
    const med = document.getElementById('peds-medication').value;
    if (!w || !med) { showToast('Enter weight and select medication', 'warning'); return; }
    const doses = {
        acetaminophen: [`${(w * 15).toFixed(1)} mg/dose`, `q4-6h PRN · max ${(w * 75).toFixed(1)} mg/day`],
        ibuprofen: [`${(w * 10).toFixed(1)} mg/dose`, `q6-8h PRN · max ${(w * 40).toFixed(1)} mg/day`],
        amoxicillin: [`${(w * 20).toFixed(1)}–${(w * 40).toFixed(1)} mg/day`, `Divided q8-12h`],
        azithromycin: [`Day 1: ${(w * 10).toFixed(1)} mg`, `Days 2–5: ${(w * 5).toFixed(1)} mg once daily`],
        ceftriaxone: [`${(w * 50).toFixed(1)}–${(w * 100).toFixed(1)} mg`, `Once or twice daily · max 2000 mg/day`]
    };
    const [dose, note] = doses[med];
    const re = document.getElementById('peds-dose-result');
    document.getElementById('peds-dose-value').textContent = dose;
    document.getElementById('peds-dose-note').textContent = note;
    re.classList.remove('result-normal', 'result-warning', 'result-danger', 'result-neutral');
    re.classList.add('result-neutral', 'show');
    addToHistory('Pediatric', med, dose);
    if (navigator.vibrate) navigator.vibrate(12);
};

window.calculateAPGAR = function () {
    const total = ['apgar-appearance', 'apgar-pulse', 'apgar-grimace', 'apgar-activity', 'apgar-respiration']
        .reduce((s, id) => s + parseInt(document.getElementById(id).value), 0);
    let status = total >= 7 ? 'normal' : total >= 4 ? 'warning' : 'danger';
    let interp = total >= 7
        ? '<strong>Normal:</strong> Baby is doing well. Routine care.'
        : total >= 4
            ? '<strong>Moderately Abnormal:</strong> Stimulation and supplemental oxygen needed.'
            : '<strong>Severely Abnormal:</strong> Immediate resuscitation required.';
    showResult('apgar-result', 'apgar-value', `${total}`, status, null, null, 'apgar-interpretation', interp);
    addToHistory('Pediatric', 'APGAR', `${total}/10`);
};

/* ==================== LAB CONVERTER ==================== */
const LAB_CONVERSIONS = {
    glucose:      { factor: 0.0555, conventional: 'mg/dL', si: 'mmol/L', decimals: 1, normalConv: '70–100 mg/dL (fasting)', normalSI: '3.9–5.6 mmol/L' },
    cholesterol:  { factor: 0.0259, conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '<200 mg/dL', normalSI: '<5.2 mmol/L' },
    hdl:          { factor: 0.0259, conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '>40 mg/dL (M)', normalSI: '>1.0 mmol/L (M)' },
    ldl:          { factor: 0.0259, conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '<100 mg/dL', normalSI: '<2.6 mmol/L' },
    triglycerides:{ factor: 0.0113, conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '<150 mg/dL', normalSI: '<1.7 mmol/L' },
    creatinine:   { factor: 88.4,   conventional: 'mg/dL', si: 'µmol/L', decimals: 0, normalConv: '0.7–1.3 mg/dL (M)', normalSI: '62–115 µmol/L (M)' },
    bun:          { factor: 0.357,  conventional: 'mg/dL', si: 'mmol/L', decimals: 1, normalConv: '7–20 mg/dL', normalSI: '2.5–7.1 mmol/L' },
    calcium:      { factor: 0.25,   conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '8.5–10.5 mg/dL', normalSI: '2.1–2.6 mmol/L' },
    magnesium:    { factor: 0.411,  conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '1.7–2.2 mg/dL', normalSI: '0.7–0.9 mmol/L' },
    phosphate:    { factor: 0.323,  conventional: 'mg/dL', si: 'mmol/L', decimals: 2, normalConv: '2.5–4.5 mg/dL', normalSI: '0.8–1.5 mmol/L' },
    bilirubin:    { factor: 17.1,   conventional: 'mg/dL', si: 'µmol/L', decimals: 1, normalConv: '0.1–1.2 mg/dL', normalSI: '2–21 µmol/L' }
};

window.convertLab = function () {
    const type = document.getElementById('lab-type').value;
    const value = parseFloat(document.getElementById('lab-value').value);
    const sys = document.getElementById('lab-unit-system').value;
    if (!value) { showToast('Please enter a lab value', 'warning'); return; }
    if (value < 0) { showToast('Lab values cannot be negative', 'warning'); return; }
    const c = LAB_CONVERSIONS[type];
    const result = sys === 'conventional' ? value * c.factor : value / c.factor;
    const unit = sys === 'conventional' ? c.si : c.conventional;
    const normal = sys === 'conventional' ? c.normalSI : c.normalConv;
    const display = `${result.toFixed(c.decimals)} ${unit}`;
    showResult('lab-result', 'lab-result-value', display, 'neutral', `Normal range: ${normal}`, 'lab-normal-range');
    addToHistory('Lab', type, display);
};

/* ==================== LIVE CONVERTERS ==================== */
function initializeConverters() {
    const lbs = document.getElementById('weight-lbs'), kg = document.getElementById('weight-kg');
    if (lbs && kg) {
        lbs.addEventListener('input', e => { const v = parseFloat(e.target.value); kg.value = v >= 0 ? (v / 2.20462).toFixed(2) : ''; });
        kg.addEventListener('input', e => { const v = parseFloat(e.target.value); lbs.value = v >= 0 ? (v * 2.20462).toFixed(2) : ''; });
    }

    const cel = document.getElementById('temp-celsius'), fahr = document.getElementById('temp-fahrenheit');
    if (cel && fahr) {
        cel.addEventListener('input', e => { const v = parseFloat(e.target.value); fahr.value = !isNaN(v) ? ((v * 9 / 5) + 32).toFixed(1) : ''; });
        fahr.addEventListener('input', e => { const v = parseFloat(e.target.value); cel.value = !isNaN(v) ? ((v - 32) * 5 / 9).toFixed(1) : ''; });
    }

    const ft = document.getElementById('height-feet'), ins = document.getElementById('height-inches'), cm = document.getElementById('height-cm');
    if (ft && ins && cm) {
        const fromFtIn = () => {
            const f = parseFloat(ft.value) || 0, i = parseFloat(ins.value) || 0;
            cm.value = (f > 0 || i > 0) ? ((f * 12 + i) * 2.54).toFixed(1) : '';
        };
        ft.addEventListener('input', fromFtIn);
        ins.addEventListener('input', fromFtIn);
        cm.addEventListener('input', e => {
            const v = parseFloat(e.target.value);
            if (v > 0) { const ti = v / 2.54; ft.value = Math.floor(ti / 12); ins.value = (ti % 12).toFixed(1); }
            else { ft.value = ''; ins.value = ''; }
        });
    }
}

/* ==================== NOTES ==================== */
function loadNotes() {
    const ta = document.getElementById('shift-notes');
    if (!ta) return;
    try { const saved = localStorage.getItem('medconvert_notes'); if (saved) ta.value = saved; } catch {}
    let saveTimeout;
    ta.addEventListener('input', e => {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            try { localStorage.setItem('medconvert_notes', e.target.value); showToast('Notes saved', 'success'); } catch {}
        }, 800);
    });
}

window.clearNotes = function () {
    if (confirm('Clear all notes? This action cannot be undone.')) {
        document.getElementById('shift-notes').value = '';
        try { localStorage.removeItem('medconvert_notes'); } catch {}
        showToast('Notes cleared', 'info');
    }
};

window.exportNotes = function () {
    const notes = document.getElementById('shift-notes').value;
    if (!notes.trim()) { showToast('No notes to export', 'warning'); return; }
    const date = new Date().toISOString().split('T')[0];
    const blob = new Blob([notes], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `MedConvert_Notes_${date}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Notes exported', 'success');
};

/* ==================== DRUG REFERENCE ==================== */
const DRUG_DB = [
    { name: 'Adenosine', category: 'Cardiac', route: 'IV', dose: '6 mg rapid IVP; repeat 12 mg if no response', onset: '~10 sec', peak: '~30 sec', notes: 'SVT termination. Flush immediately with rapid NS bolus.' },
    { name: 'Amiodarone', category: 'Antiarrhythmic', route: 'IV/PO', dose: '150 mg IV over 10 min (loading)', onset: '1–3 hrs IV', peak: 'Days–weeks', notes: 'Pulmonary/thyroid toxicity with long-term use. Monitor QT.' },
    { name: 'Atropine', category: 'Anticholinergic', route: 'IV/IM', dose: '0.5–1 mg IV q3-5 min (max 3 mg)', onset: '<1 min IV', peak: '2–4 min', notes: 'Bradycardia. Min 0.5 mg to avoid paradoxical bradycardia.' },
    { name: 'Cefazolin', category: 'Antibiotic', route: 'IV/IM', dose: '1–2 g q8h; surgical prophylaxis: 2 g', onset: '30 min', peak: '1–2 hrs', notes: '1st-gen cephalosporin. Reduce dose in renal impairment.' },
    { name: 'Dextrose 50%', category: 'Metabolic', route: 'IV', dose: '25 g (50 mL D50W)', onset: '1–3 min', peak: '5–10 min', notes: 'Symptomatic hypoglycaemia. Ensure patent IV — vesicant.' },
    { name: 'Diltiazem', category: 'Cardiac', route: 'IV/PO', dose: '0.25 mg/kg IV over 2 min', onset: '2–5 min', peak: '2–7 min', notes: 'A-fib/flutter rate control. Contraindicated in WPW, severe HF.' },
    { name: 'Dopamine', category: 'Vasopressor', route: 'IV infusion', dose: '2–20 mcg/kg/min', onset: '2–5 min', peak: 'Minutes', notes: 'Low dose: dopaminergic; mid: beta-1; high: alpha-1. Vesicant.' },
    { name: 'Epinephrine', category: 'Emergency', route: 'IV/IM/ET', dose: 'Cardiac arrest: 1 mg IV q3-5 min', onset: '<1 min', peak: '3–5 min', notes: 'Anaphylaxis IM (1:1000): 0.3–0.5 mg. Always have available.' },
    { name: 'Furosemide', category: 'Diuretic', route: 'IV/PO', dose: '20–80 mg IV (0.5–1 mg/kg)', onset: '5 min IV', peak: '30 min', notes: 'Monitor K+, Na+, fluid status. Ototoxicity at high doses.' },
    { name: 'Heparin', category: 'Anticoagulant', route: 'IV/SubQ', dose: 'DVT: 80 u/kg bolus, then 18 u/kg/hr', onset: '<5 min IV', peak: 'Minutes', notes: 'Monitor aPTT q6h. Antidote: Protamine sulfate. HIT risk.' },
    { name: 'Hydralazine', category: 'Antihypertensive', route: 'IV/IM/PO', dose: '10–20 mg IV q4-6h PRN', onset: '5–20 min IV', peak: '10–80 min', notes: 'Pregnancy-associated hypertension. Reflex tachycardia common.' },
    { name: 'Insulin (Regular)', category: 'Metabolic', route: 'IV/SubQ/IM', dose: 'DKA infusion: 0.1 units/kg/hr', onset: '30 min SubQ', peak: '2–4 hrs SubQ', notes: 'IV onset 15 min. Monitor glucose q1h on infusion. Refrigerate.' },
    { name: 'Ketorolac', category: 'Analgesic', route: 'IV/IM', dose: '15–30 mg q6h (max 5 days)', onset: '30 min', peak: '1–2 hrs', notes: 'Max 5-day course. Avoid in renal insufficiency or GI bleeding.' },
    { name: 'Labetalol', category: 'Antihypertensive', route: 'IV/PO', dose: '10–20 mg IV q10 min (max 300 mg)', onset: '2–5 min IV', peak: '5–15 min', notes: 'Alpha + beta blockade. Avoid in asthma, severe bradycardia, acute HF.' },
    { name: 'Lorazepam', category: 'Benzodiazepine', route: 'IV/IM/PO/SL', dose: 'Status epilepticus: 4 mg IV over 2 min', onset: '1–5 min IV', peak: '15–20 min', notes: 'Sedation: 0.5–2 mg IV. Monitor respirations. Refrigerate.' },
    { name: 'Magnesium Sulfate', category: 'Electrolyte', route: 'IV', dose: 'Eclampsia: 4–6 g over 15–20 min', onset: '1–2 min IV', peak: 'Minutes', notes: 'Torsades: 1–2 g IV. Monitor Mg levels and deep tendon reflexes.' },
    { name: 'Metoprolol', category: 'Beta-Blocker', route: 'IV/PO', dose: '5 mg IV q5min x3 (ACS)', onset: '1–2 min IV', peak: '5–15 min', notes: 'STEMI: up to 15 mg IV. Contraindicated in acute decompensated HF.' },
    { name: 'Midazolam', category: 'Benzodiazepine', route: 'IV/IM/IN', dose: 'Procedural sedation: 1–2.5 mg IV slowly', onset: '<2 min IV', peak: '3–5 min', notes: 'Amnestic. Short-acting. Respiratory depression risk.' },
    { name: 'Morphine', category: 'Opioid Analgesic', route: 'IV/IM/SubQ/PO', dose: '2–4 mg IV q3-4h PRN', onset: '5–10 min IV', peak: '20 min IV', notes: 'Histamine release possible. Antidote: Naloxone. Monitor respirations.' },
    { name: 'Naloxone', category: 'Reversal Agent', route: 'IV/IM/IN/SubQ', dose: '0.4–2 mg IV/IM q2-3 min', onset: '1–2 min IV', peak: '5–15 min', notes: 'Opioid reversal. Duration shorter than morphine — repeat as needed.' },
    { name: 'Nitroglycerin', category: 'Vasodilator', route: 'SL/IV/Topical', dose: 'ACS SL: 0.4 mg q5 min x3', onset: '1–3 min SL', peak: '3–5 min', notes: 'Hold if SBP <90. IV: 5–200 mcg/min. Avoid with PDE-5 inhibitors.' },
    { name: 'Norepinephrine', category: 'Vasopressor', route: 'IV infusion', dose: '0.01–3 mcg/kg/min (titrate to MAP)', onset: '1–2 min', peak: 'Minutes', notes: 'First-line in septic shock. Central line preferred. Vesicant.' },
    { name: 'Ondansetron', category: 'Antiemetic', route: 'IV/PO/IM', dose: '4 mg IV over 2–5 min q4-8h', onset: '<5 min IV', peak: '30 min', notes: 'QT prolongation risk at high doses. Safe in pregnancy.' },
    { name: 'Potassium Chloride', category: 'Electrolyte', route: 'IV/PO', dose: 'IV: max 10–20 mEq/hr (peripheral)', onset: 'During infusion', peak: 'N/A', notes: 'NEVER IV push. Monitor ECG continuously. Dilute appropriately.' },
    { name: 'Propofol', category: 'Sedative', route: 'IV infusion', dose: 'ICU sedation: 5–50 mcg/kg/min', onset: '<1 min', peak: '1–2 min', notes: 'Propofol infusion syndrome risk with high or prolonged doses.' },
    { name: 'Vancomycin', category: 'Antibiotic', route: 'IV', dose: '15–20 mg/kg q8-12h (max 3 g/dose)', onset: '30–60 min', peak: '1–2 hrs post-infusion', notes: 'Infuse over at least 60 min. Red Man Syndrome risk with rapid infusion. Monitor AUC/MIC.' }
];

const DRUG_CATEGORIES = [...new Set(DRUG_DB.map(d => d.category))].sort();

window.initDrugPanel = function () {
    const sel = document.getElementById('drug-category-filter');
    if (sel && sel.options.length <= 1) {
        DRUG_CATEGORIES.forEach(cat => {
            const o = document.createElement('option');
            o.value = cat;
            o.textContent = cat;
            sel.appendChild(o);
        });
    }
};

function makeDrugTagSVG(iconPath) {
    return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">${iconPath}</svg>`;
}

window.searchDrugs = function () {
    const q = document.getElementById('drug-search').value.toLowerCase().trim();
    const cat = document.getElementById('drug-category-filter').value;
    const el = document.getElementById('drug-results');
    if (!q && !cat) {
        el.innerHTML = `<div class="drug-placeholder">Start typing to search ${DRUG_DB.length} drugs, or filter by category above.</div>`;
        return;
    }
    const results = DRUG_DB.filter(d => {
        const mq = !q || d.name.toLowerCase().includes(q) || d.category.toLowerCase().includes(q) || d.notes.toLowerCase().includes(q) || d.dose.toLowerCase().includes(q);
        const mc = !cat || d.category === cat;
        return mq && mc;
    });
    if (results.length === 0) {
        el.innerHTML = `<div class="drug-placeholder">No results found for "${q || cat}"</div>`;
        return;
    }
    el.innerHTML = results.map(d => buildDrugCard(d)).join('');
};

window.clearDrugSearch = function () {
    document.getElementById('drug-search').value = '';
    document.getElementById('drug-category-filter').value = '';
    document.getElementById('drug-results').innerHTML = `<div class="drug-placeholder">Start typing to search ${DRUG_DB.length} drugs, or filter by category above.</div>`;
};

/* ==================== BACK TO TOP ==================== */
function initBackToTop() {
    const btn = document.getElementById('back-to-top');
    if (!btn) return;
    window.addEventListener('scroll', () => {
        btn.classList.toggle('visible', window.scrollY > 400);
    });
    btn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
}

/* ==================== SCROLL REVEAL ==================== */
function initScrollReveal() {
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
}

/* ==================== SERVICE WORKER ==================== */
function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/medconvert-sw.js').catch(() => {});
    }
}

/* ==================== KEYBOARD SHORTCUTS ==================== */
document.addEventListener('keydown', e => {
    if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '9') {
        e.preventDefault();
        const tabs = document.querySelectorAll('.tab-btn');
        const idx = parseInt(e.key) - 1;
        if (tabs[idx]) tabs[idx].click();
    }
});

console.log('MedConvert — Ghibli Edition loaded. Built with care.');

/* ==========================================
   HCI ENHANCEMENT LAYER
   All 8 principles applied intentionally
   ==========================================
   1. Consistency      — unified ARIA roles, focus patterns
   2. Visibility       — live regions, status indicators, form states
   3. Feedback         — ripple effects, confirm toasts, button states
   4. Affordance       — button loading states, visual cues
   5. Accessibility    — keyboard trap for modals, ARIA attributes
   6. Cognitive Load   — progressive disclosure, contextual help
   7. Fitts's Law      — keyboard shortcut panel, quick access
   8. User Control     — undo, escape key, cancel patterns
   =========================================== */

/* HCI Init: Append all enhancements after DOMContentLoaded */
document.addEventListener('DOMContentLoaded', () => {
    hci_initSkipLink();
    hci_initARIALiveRegion();
    hci_initFormValidation();
    hci_initButtonFeedback();
    hci_initKeyboardNavigation();
    hci_initFocusTrap();
    hci_initTabARIA();
    hci_initBackToTopARIA();
    hci_initScrollThreshold();
    hci_initDrugCount();
    hci_initInputHints();
    hci_patchShowResult();
    hci_patchShowToast();
    hci_initEscapeClose();
});


function hci_initSkipLink() {
    // Inject skip link if not already in DOM
    if (document.querySelector('.skip-link')) return;
    const skip = document.createElement('a');
    skip.href = '#main-content';
    skip.className = 'skip-link';
    skip.textContent = 'Skip to main content';
    document.body.insertBefore(skip, document.body.firstChild);

    // Ensure main content has proper id
    const main = document.querySelector('main, .container');
    if (main && !main.id) main.id = 'main-content';
}

/* ARIA live region */
function hci_initARIALiveRegion() {
    if (document.getElementById('hci-live-region')) return;
    const live = document.createElement('div');
    live.id = 'hci-live-region';
    live.setAttribute('role', 'status');
    live.setAttribute('aria-live', 'polite');
    live.setAttribute('aria-atomic', 'true');
    live.style.cssText = 'position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;';
    document.body.appendChild(live);
}

function hci_announce(msg) {
    const r = document.getElementById('hci-live-region');
    if (!r) return;
    r.textContent = '';
    requestAnimationFrame(() => { r.textContent = msg; });
}

/* Form validation */
function hci_initFormValidation() {
    // Add visual validation feedback to all number/text inputs
    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
        // Hover: show focus ring preview
        input.addEventListener('mouseenter', () => {
            input.style.cursor = 'text';
        });

        // Validation on blur — check if required and empty
        input.addEventListener('blur', () => {
            hci_validateInput(input);
        });

        // Clear error on typing — give immediate positive feedback
        input.addEventListener('input', () => {
            if (input.value.trim()) {
                input.classList.remove('input-error');
                input.classList.add('input-success');
                const errEl = input.nextElementSibling;
                if (errEl && errEl.classList.contains('field-error')) {
                    errEl.classList.remove('visible');
                }
            } else {
                input.classList.remove('input-success');
            }
        });
    });
}

function hci_validateInput(input) {
    const isEmpty = !input.value.trim();
    const isNumber = input.type === 'number';
    const isNegative = isNumber && parseFloat(input.value) < 0;
    const isZero = isNumber && parseFloat(input.value) === 0;

    if (isEmpty && input.required) {
        input.classList.add('input-error');
        input.classList.remove('input-success');
        hci_showFieldError(input, 'This field is required');
    } else if (isNegative) {
        input.classList.add('input-error');
        input.classList.remove('input-success');
        hci_showFieldError(input, 'Please enter a positive value');
    } else if (!isEmpty) {
        input.classList.remove('input-error');
        input.classList.add('input-success');
        hci_hideFieldError(input);
    }
}

function hci_showFieldError(input, message) {
    let errEl = input.parentElement.querySelector('.field-error');
    if (!errEl) {
        errEl = document.createElement('div');
        errEl.className = 'field-error';
        errEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg><span></span>`;
        input.insertAdjacentElement('afterend', errEl);
    }
    errEl.querySelector('span').textContent = message;
    errEl.classList.add('visible');
    input.setAttribute('aria-invalid', 'true');
    input.setAttribute('aria-describedby', errEl.id || (errEl.id = `err-${Math.random().toString(36).slice(2)}`));
}

function hci_hideFieldError(input) {
    const errEl = input.parentElement.querySelector('.field-error');
    if (errEl) errEl.classList.remove('visible');
    input.removeAttribute('aria-invalid');
    input.removeAttribute('aria-describedby');
}

/* Button feedback */
function hci_initButtonFeedback() {
    // All primary buttons get ripple effect and active feedback
    document.querySelectorAll('.btn-primary').forEach(btn => {
        btn.addEventListener('click', function(e) {
            // Ripple effect at click point
            const rect = btn.getBoundingClientRect();
            const ripple = document.createElement('span');
            const size = Math.max(rect.width, rect.height);
            ripple.style.cssText = `
                position:absolute;
                width:${size}px;height:${size}px;
                top:${e.clientY - rect.top - size/2}px;
                left:${e.clientX - rect.left - size/2}px;
                background:rgba(255,255,255,0.22);
                border-radius:50%;
                transform:scale(0);
                animation:ripple 0.45s ease-out;
                pointer-events:none;
            `;
            btn.style.position = 'relative';
            btn.style.overflow = 'hidden';
            btn.appendChild(ripple);
            setTimeout(() => ripple.remove(), 450);
        });
    });

    // Inject ripple keyframes once
    if (!document.getElementById('hci-ripple-style')) {
        const style = document.createElement('style');
        style.id = 'hci-ripple-style';
        style.textContent = `@keyframes ripple { to { transform: scale(2.5); opacity: 0; } }`;
        document.head.appendChild(style);
    }
}

/* Keyboard navigation */
function hci_initKeyboardNavigation() {
    const tabNav = document.querySelector('.tab-nav');
    if (!tabNav) return;

    tabNav.addEventListener('keydown', (e) => {
        const tabs = [...tabNav.querySelectorAll('.tab-btn')];
        const current = document.activeElement;
        const idx = tabs.indexOf(current);
        if (idx === -1) return;

        let next = -1;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
            e.preventDefault();
            next = (idx + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
            e.preventDefault();
            next = (idx - 1 + tabs.length) % tabs.length;
        } else if (e.key === 'Home') {
            e.preventDefault(); next = 0;
        } else if (e.key === 'End') {
            e.preventDefault(); next = tabs.length - 1;
        }

        if (next !== -1) {
            tabs[next].focus();
            tabs[next].click();
        }
    });

    // Sub-tab keyboard navigation — same pattern (Consistency)
    document.querySelectorAll('.sub-tabs').forEach(subTabGroup => {
        subTabGroup.addEventListener('keydown', (e) => {
            const tabs = [...subTabGroup.querySelectorAll('.sub-tab')];
            const current = document.activeElement;
            const idx = tabs.indexOf(current);
            if (idx === -1) return;

            let next = -1;
            if (e.key === 'ArrowRight') { e.preventDefault(); next = (idx + 1) % tabs.length; }
            else if (e.key === 'ArrowLeft') { e.preventDefault(); next = (idx - 1 + tabs.length) % tabs.length; }

            if (next !== -1) { tabs[next].focus(); tabs[next].click(); }
        });
    });
}


function hci_initFocusTrap() {
    // Patches the global open functions to trap focus inside the modal
    const FOCUSABLE = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

    function trapFocus(overlay) {
        if (!overlay) return;
        const focusable = [...overlay.querySelectorAll(FOCUSABLE)].filter(el => !el.disabled);
        if (!focusable.length) return;
        const first = focusable[0], last = focusable[focusable.length - 1];

        // Return focus to triggering element when closed
        const trigger = document.activeElement;

        // Set initial focus inside the modal
        requestAnimationFrame(() => {
            requestAnimationFrame(() => { first.focus(); });
        });

        const handler = (e) => {
            if (e.key !== 'Tab') return;
            if (e.shiftKey) {
                if (document.activeElement === first) { e.preventDefault(); last.focus(); }
            } else {
                if (document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        };

        overlay.addEventListener('keydown', handler);
        overlay._focusTrapHandler = handler;
        overlay._focusTrigger = trigger;
    }

    function releaseFocus(overlay) {
        if (!overlay) return;
        if (overlay._focusTrapHandler) overlay.removeEventListener('keydown', overlay._focusTrapHandler);
        if (overlay._focusTrigger) overlay._focusTrigger.focus();
    }

    // Monkey-patch showOnboarding / openSettings / openPinManager to apply traps
    const _origShowOnboarding = window.showOnboarding;
    const _origOpenSettings   = window.openSettings;
    const _origOpenPinManager = window.openPinManager;
    const _origSubmitOnboard  = window.submitOnboarding;
    const _origClosePinMgr    = window.closePinManager;

    function attachTrap(id) {
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const overlay = document.getElementById(id);
                    if (overlay) trapFocus(overlay);
                });
            });
        });
    }

    function detachTrap(id) {
        const overlay = document.getElementById(id);
        if (overlay) releaseFocus(overlay);
    }

    if (_origOpenSettings) {
        window.openSettings = function() {
            _origOpenSettings.apply(this, arguments);
            attachTrap('onboarding-overlay');
        };
    }

    if (_origOpenPinManager) {
        window.openPinManager = function() {
            _origOpenPinManager.apply(this, arguments);
            attachTrap('pin-overlay');
        };
    }

    if (_origSubmitOnboard) {
        window.submitOnboarding = function() {
            detachTrap('onboarding-overlay');
            _origSubmitOnboard.apply(this, arguments);
        };
    }

    if (_origClosePinMgr) {
        window.closePinManager = function() {
            detachTrap('pin-overlay');
            _origClosePinMgr.apply(this, arguments);
        };
    }
}

/* Tab ARIA */
function hci_initTabARIA() {
    const tabNav = document.querySelector('.tab-nav');
    if (tabNav) {
        tabNav.setAttribute('role', 'tablist');
        tabNav.setAttribute('aria-label', 'Calculator sections');

        document.querySelectorAll('.tab-btn').forEach((btn, i) => {
            btn.setAttribute('role', 'tab');
            const tabId = btn.getAttribute('data-tab');
            if (tabId) {
                btn.setAttribute('aria-controls', `panel-${tabId}`);
                btn.id = btn.id || `tab-${tabId}`;
                const panel = document.getElementById(`panel-${tabId}`);
                if (panel) {
                    panel.setAttribute('role', 'tabpanel');
                    panel.setAttribute('aria-labelledby', btn.id);
                    panel.setAttribute('tabindex', '0');
                }
            }
            // Make non-active tabs not in tab order (managed tabindex pattern)
            if (!btn.classList.contains('active')) {
                btn.setAttribute('tabindex', '-1');
            }
        });

        // Patch switchToTab to update tabindex properly
        const _origSwitch = window.switchToTab;
        if (_origSwitch) {
            window.switchToTab = function(tabId) {
                _origSwitch(tabId);
                // Update managed tabindex
                document.querySelectorAll('.tab-btn').forEach(b => {
                    const isActive = b.getAttribute('data-tab') === tabId;
                    b.setAttribute('tabindex', isActive ? '0' : '-1');
                });
                // Announce to screen readers
                const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                if (activeBtn) {
                    hci_announce(`${activeBtn.textContent.trim()} section selected`);
                }
            };
        }
    }
}


function hci_initEscapeClose() {
    document.addEventListener('keydown', (e) => {
        if (e.key !== 'Escape') return;

        const pinOverlay = document.getElementById('pin-overlay');
        if (pinOverlay && pinOverlay.classList.contains('visible')) {
            if (window.closePinManager) window.closePinManager();
            return;
        }

        const onboardOverlay = document.getElementById('onboarding-overlay');
        if (onboardOverlay && onboardOverlay.classList.contains('visible')) {
            const isFirstTime = !window.getProfile || !window.getProfile();
            if (!isFirstTime) {
                // Only allow escape on settings edit, not initial onboarding
                onboardOverlay.classList.remove('visible');
                onboardOverlay.classList.add('hiding');
                setTimeout(() => onboardOverlay.remove(), 400);
            }
        }
    });
}


function hci_initBackToTopARIA() {
    const btn = document.getElementById('back-to-top');
    if (!btn) return;
    btn.setAttribute('aria-label', 'Back to top');
    btn.setAttribute('role', 'button');
    // Keyboard: Enter and Space activate
    btn.setAttribute('tabindex', '0');
    btn.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            window.scrollTo({ top: 0, behavior: 'smooth' });
            hci_announce('Scrolled to top of page');
        }
    });
}


function hci_initScrollThreshold() {
    let wasVisible = false;
    window.addEventListener('scroll', () => {
        const isVisible = window.scrollY > 400;
        if (isVisible && !wasVisible) {
            // Button is newly appearing — brief pulse to draw attention
            const btn = document.getElementById('back-to-top');
            if (btn) {
                btn.style.animation = 'none';
                requestAnimationFrame(() => {
                    btn.style.animation = '';
                });
            }
        }
        wasVisible = isVisible;
    }, { passive: true });
}


function hci_initDrugCount() {
    const countEl = document.getElementById('drug-count');
    if (!countEl) return;

    // Patch searchDrugs to also announce count via live region
    const _origSearch = window.searchDrugs;
    if (_origSearch) {
        window.searchDrugs = function() {
            _origSearch.apply(this, arguments);
            // Update aria count after render
            requestAnimationFrame(() => {
                const cards = document.querySelectorAll('.drug-card');
                const count = cards.length;
                if (count > 0) {
                    hci_announce(`${count} drug${count !== 1 ? 's' : ''} found`);
                }
            });
        };
    }
}


function hci_initInputHints() {
    // Map of input IDs to their hint text
    const hints = {
        'dose-desired':      'The dose prescribed by the physician',
        'dose-stock':        'The dose available in your current supply',
        'dose-volume':       'Volume the stock dose is dissolved in (usually mL)',
        'weight-dose-kg':    'Patient weight in kilograms',
        'weight-dose-per-kg':'Dose in mg per kg of body weight',
        'bp-sys':            'Upper (systolic) blood pressure value',
        'bp-dia':            'Lower (diastolic) blood pressure value',
        'iv-volume':         'Total volume of fluid to be infused (mL)',
        'iv-time':           'Time for infusion in minutes',
        'bsa-height':        'Patient height in centimetres',
        'bsa-weight':        'Patient weight in kilograms',
        'si-hr':             'Current heart rate in beats per minute',
        'si-sbp':            'Systolic blood pressure (top number)',
    };

    Object.entries(hints).forEach(([id, hint]) => {
        const input = document.getElementById(id);
        if (!input) return;

        // Add a ARIA describedby hint (screen reader friendly)
        const hintId = `hint-${id}`;
        if (!document.getElementById(hintId)) {
            const hintEl = document.createElement('div');
            hintEl.id = hintId;
            hintEl.style.cssText = 'font-size:0.75rem;color:var(--text-muted);margin-top:0.25rem;display:none;font-family:var(--font-body);line-height:1.4;';
            hintEl.textContent = hint;
            input.insertAdjacentElement('afterend', hintEl);
            input.setAttribute('aria-describedby', hintId);

            input.addEventListener('focus', () => { hintEl.style.display = 'block'; });
            input.addEventListener('blur',  () => { hintEl.style.display = 'none'; });
        }
    });
}


function hci_patchShowResult() {
    const _orig = window.showResult || function(){};
    window.showResult = function(resultElId, valueElId, displayValue, status, note, noteElId, interpElId, interpHtml) {
        _orig.apply(this, arguments);
        // Announce result to screen reader
        const statusWords = { normal: 'Normal', warning: 'Caution', danger: 'Alert', neutral: 'Result' };
        const prefix = statusWords[status] || 'Result';
        const noteText = (noteElId && note) ? `. ${note}` : '';
        hci_announce(`${prefix}: ${displayValue}${noteText}`);
    };
}


function hci_patchShowToast() {
    const _orig = window.showToast || function(){};
    window.showToast = function(msg, type) {
        _orig.apply(this, arguments);
        hci_announce(msg);
    };
    // Also make showToast global from medconvert.js accessible after overwrite
}


document.addEventListener('DOMContentLoaded', () => {
    // Theme toggle
    const themeBtn = document.getElementById('theme-toggle');
    if (themeBtn && !themeBtn.getAttribute('aria-label')) {
        themeBtn.setAttribute('aria-label', 'Toggle colour theme');
    }

    // Settings button
    const settingsBtn = document.querySelector('.icon-btn[onclick*="Settings"]');
    if (settingsBtn && !settingsBtn.getAttribute('aria-label')) {
        settingsBtn.setAttribute('aria-label', 'Open settings');
    }

    // All icon buttons without aria-label
    document.querySelectorAll('.icon-btn').forEach(btn => {
        if (!btn.getAttribute('aria-label') && !btn.getAttribute('aria-labelledby')) {
            const title = btn.title || btn.getAttribute('data-tooltip') || 'Action button';
            btn.setAttribute('aria-label', title);
        }
    });

    // All buttons in general — ensure they have accessible names
    document.querySelectorAll('button:not([aria-label]):not([aria-labelledby])').forEach(btn => {
        if (!btn.textContent.trim() && !btn.querySelector('text')) {
            btn.setAttribute('aria-label', 'Button');
        }
    });

    // Drug count: initial state
    const countEl = document.getElementById('drug-count');
    if (countEl) countEl.setAttribute('aria-live', 'polite');
});


(function hci_tabScrollIntoView() {
    // Patch switchToTab to scroll active tab button into view
    const _orig = window.switchToTab;
    if (_orig) {
        window.switchToTab = function(tabId) {
            _orig.apply(this, arguments);
            requestAnimationFrame(() => {
                const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
                if (activeBtn) {
                    activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }
            });
        };
    }
})();


document.addEventListener('DOMContentLoaded', () => {
    // Observe input success states and auto-clear after timeout
    const successTimeout = new Map();
    document.addEventListener('input', (e) => {
        const input = e.target;
        if (!input.classList || !input.classList.contains('input-success')) return;
        if (successTimeout.has(input)) clearTimeout(successTimeout.get(input));
        successTimeout.set(input, setTimeout(() => {
            input.classList.remove('input-success');
            successTimeout.delete(input);
        }, 3000));
    });
});


(function hci_calcButtonStates() {
    document.addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-primary');
        if (!btn) return;
        // Don't apply to nav/settings buttons
        if (btn.closest('.header-controls') || btn.closest('#onboarding-overlay') || btn.closest('#pin-overlay')) return;

        // Brief visual press state
        btn.style.transform = 'scale(0.975)';
        setTimeout(() => { btn.style.transform = ''; }, 120);
    });
})();

console.log('MedConvert HCI layer loaded — 8 principles applied.');
/* Improvement patch */

/* Offline indicator */
function initOfflineIndicator() {
    const badge = document.getElementById('offline-badge');
    if (!badge) return;
    const dot = badge.querySelector('.offline-dot');
    const label = badge.querySelector('.offline-label');

    function update() {
        const online = navigator.onLine;
        badge.classList.toggle('is-offline', !online);
        label.textContent = online ? 'Online' : 'Offline';
        badge.title = online ? 'Connected' : 'No internet — using cached data';
    }

    update();
    window.addEventListener('online', () => { update(); showToast('Back online', 'success'); });
    window.addEventListener('offline', () => { update(); showToast('Working offline — all features still available', 'info'); });
}

/* Enter to calculate */
function initEnterToCalculate() {
    // Map: panel ID → calculate function name
    const panelCalcMap = {
        'panel-dosage': { 'sub-dosage-standard': 'calculateDosage', 'sub-dosage-weight': 'calculateWeightDose', 'sub-dosage-bsa': 'calculateBSA' },
        'panel-iv':     { 'sub-drip-rate': 'calculateIV', 'sub-infusion-time': 'calculateInfusionTime', 'sub-concentration': 'calculateConcentration' },
        'panel-vitals': { 'sub-map': 'calculateMAP', 'sub-pp': 'calculatePP', 'sub-shock-index': 'calculateShockIndex', 'sub-a-a-gradient': 'calculateAAGradient' },
        'panel-assessment': { 'sub-gcs': 'calculateGCS', 'sub-bmi': 'calculateBMI', 'sub-egfr': 'calculateEGFR', 'sub-wells': 'calculateWells' },
        'panel-pediatric': { 'sub-peds-weight': 'calculatePedsWeight', 'sub-peds-dose': 'calculatePedsDose', 'sub-apgar': 'calculateAPGAR' },
        'panel-lab':     { '_default': 'convertLab' },
    };

    document.addEventListener('keydown', (e) => {
        if (e.key !== 'Enter') return;
        // Only if focused inside an input (not a button or textarea)
        const active = document.activeElement;
        if (!active || !['INPUT', 'SELECT'].includes(active.tagName)) return;
        // Don't trigger if inside onboarding or modals
        if (active.closest('#onboarding-overlay, #pin-overlay, #confirm-modal')) return;

        // Find which panel is active
        const activePanel = document.querySelector('.calc-card.active');
        if (!activePanel) return;
        const panelId = activePanel.id;
        const panelMap = panelCalcMap[panelId];
        if (!panelMap) return;

        // Find active sub-panel
        const activeSubPanel = activePanel.querySelector('.sub-panel.active');
        const subId = activeSubPanel ? activeSubPanel.id : '_default';

        let fn = panelMap[subId] || panelMap['_default'];
        if (!fn) {
            // If only one entry in map, use that
            const entries = Object.values(panelMap);
            if (entries.length === 1) fn = entries[0];
        }

        if (fn && window[fn]) {
            e.preventDefault();
            window[fn]();
        }
    });
}

/* Copy result button */
function initCopyResultButtons() {
    // Add copy button to each result-display
    document.querySelectorAll('.result-display').forEach(resultEl => {
        if (resultEl.querySelector('.result-copy-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'result-copy-btn';
        btn.type = 'button';
        btn.setAttribute('aria-label', 'Copy result to clipboard');
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copy`;
        btn.addEventListener('click', () => {
            const valueEl = resultEl.querySelector('.result-value');
            const noteEl = resultEl.querySelector('.result-note');
            if (!valueEl) return;
            const text = valueEl.textContent.trim() + (noteEl ? '\n' + noteEl.textContent.trim() : '');
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = '✓ Copied!';
                btn.innerHTML = '✓ Copied!';
                setTimeout(() => {
                    btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>Copy`;
                }, 1800);
                showToast('Result copied to clipboard', 'success');
            }).catch(() => showToast('Copy not supported in this browser', 'warning'));
        });
        resultEl.appendChild(btn);
    });
}

/* Clear inputs button */
function addClearInputButtons() {
    // Add "New Calculation" clear button to each result-display
    document.querySelectorAll('.result-display').forEach(resultEl => {
        if (resultEl.querySelector('.calc-clear-btn')) return;
        const btn = document.createElement('button');
        btn.className = 'calc-clear-btn';
        btn.type = 'button';
        btn.setAttribute('aria-label', 'Clear inputs for new calculation');
        btn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 .49-3.5"></path></svg>New Calc`;
        btn.addEventListener('click', () => {
            // Clear all inputs in the parent sub-panel or calc-card
            const parent = resultEl.closest('.sub-panel') || resultEl.closest('.calc-card');
            if (!parent) return;
            parent.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                input.value = '';
                input.classList.remove('input-error', 'input-success');
            });
            parent.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
            // Hide result
            resultEl.classList.remove('show', 'result-normal', 'result-warning', 'result-danger', 'result-neutral');
            // Focus first input
            const first = parent.querySelector('input[type="number"], input[type="text"], select');
            if (first) first.focus();
            showToast('Inputs cleared', 'info');
        });
        resultEl.appendChild(btn);
    });
}

/* Timer progress ring */
let timerTotal = 0;
const RING_CIRCUMFERENCE = 326.7; // 2 * π * 52

function updateTimerRing(secondsLeft) {
    const ring = document.getElementById('timer-ring-fill');
    if (!ring) return;
    const pct = timerTotal > 0 ? secondsLeft / timerTotal : 0;
    const offset = RING_CIRCUMFERENCE * (1 - pct);
    ring.style.strokeDashoffset = offset;
    ring.classList.toggle('ring-urgent', secondsLeft <= 5 && secondsLeft > 0);
}

// Patch startTimer to update ring
const _origStartTimer = window.startTimer;
window.startTimer = function(seconds) {
    timerTotal = seconds;
    updateTimerRing(seconds);
    _origStartTimer.call(this, seconds);
};

const _origUpdateTimerDisplay = window.updateTimerDisplay;
// We need to hook into the interval - patch via overriding the whole timer
let _timerPatchInterval = null;
const _origStartTimer2 = window.startTimer;
window.startTimer = function(seconds) {
    timerTotal = seconds;
    updateTimerRing(seconds);
    // Clear existing
    if (_timerPatchInterval) clearInterval(_timerPatchInterval);
    const display = document.getElementById('timer-countdown');
    let left = seconds;
    _updateTimerDisplayLocal(left);
    _timerPatchInterval = setInterval(() => {
        left--;
        _updateTimerDisplayLocal(left);
        updateTimerRing(left);
        if (left <= 0) {
            clearInterval(_timerPatchInterval);
            if (display) { display.textContent = 'Done'; display.style.color = 'var(--dusty-rose)'; }
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
            showToast('Timer complete', 'success');
        }
    }, 1000);
    if (navigator.vibrate) navigator.vibrate(12);
};

function _updateTimerDisplayLocal(s) {
    const d = document.getElementById('timer-countdown');
    if (!d) return;
    d.textContent = s >= 60 ? `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}` : s.toString().padStart(2, '0');
    d.style.color = s <= 5 && s > 0 ? 'var(--danger)' : 'var(--forest)';
}

const _origResetTimer = window.resetTimer;
window.resetTimer = function() {
    if (_timerPatchInterval) clearInterval(_timerPatchInterval);
    const d = document.getElementById('timer-countdown');
    if (d) { d.textContent = '00'; d.style.color = 'var(--forest)'; }
    timerTotal = 0;
    updateTimerRing(0);
    if (navigator.vibrate) navigator.vibrate(5);
};

/* Sub-tab memory */
const subTabMemory = {};

const _origShowSubPanel = window.showSubPanel;
window.showSubPanel = function(subId) {
    // Remember which sub-panel was selected per parent panel
    const clickedBtn = event ? (event.currentTarget || event.target) : null;
    if (clickedBtn) {
        const parentCard = clickedBtn.closest('.calc-card');
        if (parentCard) subTabMemory[parentCard.id] = subId;
    }
    _origShowSubPanel.apply(this, arguments);
};

const _origSwitchToTab2 = window.switchToTab;
window.switchToTab = function(tabId) {
    _origSwitchToTab2.apply(this, arguments);
    // Restore remembered sub-tab
    const panelId = `panel-${tabId}`;
    const remembered = subTabMemory[panelId];
    if (remembered) {
        const panel = document.getElementById(panelId);
        if (panel) {
            const targetSub = document.getElementById(`sub-${remembered}`);
            if (targetSub) {
                panel.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
                panel.querySelectorAll('.sub-panel').forEach(p => p.classList.remove('active'));
                targetSub.classList.add('active');
                // Find and activate corresponding sub-tab button
                panel.querySelectorAll('.sub-tab').forEach(b => {
                    if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${remembered}'`)) {
                        b.classList.add('active');
                    }
                });
            }
        }
    }
};

/* Show all drugs on load */
const _origInitDrugPanel = window.initDrugPanel;
window.initDrugPanel = function() {
    _origInitDrugPanel.apply(this, arguments);
    // Auto-show all drugs on panel open
    const el = document.getElementById('drug-results');
    if (el) renderAllDrugs();
};

function renderAllDrugs() {
    const el = document.getElementById('drug-results');
    if (!el || !window.DRUG_DB) return;
    const count = document.getElementById('drug-count');
    if (count) count.textContent = `${DRUG_DB.length} drugs`;
    el.innerHTML = DRUG_DB.map(d => buildDrugCard(d)).join('');
}

function buildDrugCard(d) {
    const favs = getDrugFavorites();
    const isFav = favs.includes(d.name);
    return `<div class="drug-card${isFav ? ' drug-fav-active' : ''}">
        <div class="drug-header">
            <span class="drug-name">${d.name}</span>
            <div style="display:flex;align-items:center;gap:0.5rem;">
                <span class="drug-badge">${d.category}</span>
                <button class="drug-fav-btn${isFav ? ' is-fav' : ''}" onclick="toggleDrugFav('${d.name}', this)" title="${isFav ? 'Remove from favorites' : 'Add to favorites'}" aria-label="Favorite ${d.name}">
                    <svg viewBox="0 0 24 24" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                </button>
            </div>
        </div>
        <div class="drug-meta">
            <span class="drug-tag">${d.route}</span>
            <span class="drug-tag">Onset: ${d.onset}</span>
            <span class="drug-tag">Peak: ${d.peak}</span>
        </div>
        <div class="drug-dose"><strong>Dose:</strong> ${d.dose}</div>
        <div class="drug-notes">${d.notes}</div>
    </div>`;
}

// Also patch searchDrugs to reset to all when cleared
const _origSearchDrugs = window.searchDrugs;
window.searchDrugs = function() {
    const q = document.getElementById('drug-search') ? document.getElementById('drug-search').value.toLowerCase().trim() : '';
    const cat = document.getElementById('drug-category-filter') ? document.getElementById('drug-category-filter').value : '';
    if (!q && !cat) {
        renderAllDrugs();
        return;
    }
    _origSearchDrugs.apply(this, arguments);
};

const _origClearDrugSearch = window.clearDrugSearch;
window.clearDrugSearch = function() {
    if (document.getElementById('drug-search')) document.getElementById('drug-search').value = '';
    if (document.getElementById('drug-category-filter')) document.getElementById('drug-category-filter').value = '';
    renderAllDrugs();
};

/* Confirm modal */
function initConfirmModal() {
    const modal = document.getElementById('confirm-modal');
    const cancelBtn = document.getElementById('confirm-cancel');
    const okBtn = document.getElementById('confirm-ok');
    if (!modal || !cancelBtn || !okBtn) return;

    cancelBtn.addEventListener('click', () => closeConfirmModal());
    modal.addEventListener('click', (e) => { if (e.target === modal) closeConfirmModal(); });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('visible')) closeConfirmModal();
    });

    // Override clearNotes
    window.clearNotes = function() {
        showConfirmModal(() => {
            document.getElementById('shift-notes').value = '';
            try { localStorage.removeItem('medconvert_notes'); } catch {}
            showToast('Notes cleared', 'info');
        });
    };
}

function showConfirmModal(onConfirm) {
    const modal = document.getElementById('confirm-modal');
    if (!modal) return;
    modal.classList.add('visible');
    const okBtn = document.getElementById('confirm-ok');
    // Remove old listener
    const newOk = okBtn.cloneNode(true);
    okBtn.parentNode.replaceChild(newOk, okBtn);
    newOk.addEventListener('click', () => {
        closeConfirmModal();
        if (onConfirm) onConfirm();
    });
    // Focus cancel (safer default)
    setTimeout(() => document.getElementById('confirm-cancel') && document.getElementById('confirm-cancel').focus(), 50);
}

function closeConfirmModal() {
    const modal = document.getElementById('confirm-modal');
    if (modal) modal.classList.remove('visible');
}

/* Weight unit toggle */
window.setWeightUnit = function(btn, inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    const group = btn.closest('.unit-toggle-group');
    group.querySelectorAll('.unit-toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const fromUnit = input.dataset.unit || 'kg';
    const toUnit = btn.dataset.unit;
    if (fromUnit === toUnit) return;
    const val = parseFloat(input.value);
    if (!isNaN(val) && val > 0) {
        if (toUnit === 'lbs' && fromUnit === 'kg') input.value = (val * 2.20462).toFixed(1);
        else if (toUnit === 'kg' && fromUnit === 'lbs') input.value = (val / 2.20462).toFixed(1);
    }
    input.dataset.unit = toUnit;
    input.placeholder = toUnit === 'lbs' ? 'e.g., 154' : 'e.g., 70';
};

// Patch calculate functions to convert lbs→kg before calculating
function getWeightInKg(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return null;
    const val = parseFloat(input.value);
    if (isNaN(val) || val <= 0) return null;
    return input.dataset.unit === 'lbs' ? val / 2.20462 : val;
}

// Patch weight-based calculations to use getWeightInKg
const _origCalcWeightDose = window.calculateWeightDose;
window.calculateWeightDose = function() {
    const w = getWeightInKg('weight-dose-kg');
    const d = parseFloat(document.getElementById('weight-dose-per-kg').value);
    const f = parseInt(document.getElementById('weight-dose-freq').value) || 1;
    if (!w || !d) { showToast('Please enter weight and dose per kg', 'warning'); return; }
    const single = w * d, daily = single * f;
    const display = `${single.toFixed(1)} mg / dose`;
    showResult('weight-dose-result', 'weight-dose-value', display, 'neutral', `Total daily: ${daily.toFixed(1)} mg (${f}× per day)`, 'weight-dose-note');
    addToHistory('Dosage', 'Weight-based', display);
};

const _origCalcBSA = window.calculateBSA;
window.calculateBSA = function() {
    const h = parseFloat(document.getElementById('bsa-height').value);
    const w = getWeightInKg('bsa-weight');
    if (!h || !w) { showToast('Please enter height and weight', 'warning'); return; }
    const bsa = Math.sqrt((h * w) / 3600);
    const display = `${bsa.toFixed(2)} m²`;
    showResult('bsa-result', 'bsa-value', display, 'neutral');
    window.currentBSA = bsa;
    addToHistory('Dosage', 'BSA', display);
};

const _origCalcBMI = window.calculateBMI;
window.calculateBMI = function() {
    const h = parseFloat(document.getElementById('bmi-height').value);
    const w = getWeightInKg('bmi-weight');
    if (!h || !w || h <= 0 || w <= 0) { showToast('Please enter valid height and weight', 'warning'); return; }
    const bmi = w / Math.pow(h / 100, 2);
    const display = bmi.toFixed(1);
    let status = 'normal', cat = 'Normal weight';
    if (bmi < 18.5) { status = 'warning'; cat = 'Underweight'; }
    else if (bmi >= 30) { status = 'danger'; cat = 'Obese'; }
    else if (bmi >= 25) { status = 'warning'; cat = 'Overweight'; }
    showResult('bmi-result', 'bmi-result-value', display, status, cat, 'bmi-category');
    addToHistory('Assessment', 'BMI', display);
};

/* eGFR 2021 */
window.calculateEGFR = function() {
    const age = parseInt(document.getElementById('egfr-age').value);
    const sex = document.getElementById('egfr-sex').value;
    const cr = parseFloat(document.getElementById('egfr-cr').value);
    if (!age || !cr) { showToast('Please enter age and creatinine', 'warning'); return; }
    // 2021 CKD-EPI (race-neutral)
    const kappa = sex === 'female' ? 0.7 : 0.9;
    const alpha = sex === 'female' ? -0.241 : -0.302;
    const sf = sex === 'female' ? 1.012 : 1.0;
    const egfr = Math.round(142 * Math.pow(Math.min(cr / kappa, 1), alpha) * Math.pow(Math.max(cr / kappa, 1), -1.200) * Math.pow(0.9938, age) * sf);
    const display = `${egfr} mL/min/1.73m²`;
    let status = egfr >= 60 ? 'normal' : egfr >= 30 ? 'warning' : 'danger';
    let stage = egfr >= 90 ? '<strong>Stage 1:</strong> Normal or high' : egfr >= 60 ? '<strong>Stage 2:</strong> Mildly decreased' : egfr >= 45 ? '<strong>Stage 3a:</strong> Mild-to-moderate decrease' : egfr >= 30 ? '<strong>Stage 3b:</strong> Moderate-to-severe decrease' : egfr >= 15 ? '<strong>Stage 4:</strong> Severely decreased' : '<strong>Stage 5:</strong> Kidney failure';
    stage += '<br><small style="opacity:0.7;font-weight:400;">Calculated using 2021 CKD-EPI race-neutral equation</small>';
    showResult('egfr-result', 'egfr-value', display, status, null, null, 'egfr-stage', stage);
    addToHistory('Assessment', 'eGFR', display);
};

/* Tab scroll fade */
function initTabScrollHint() {
    const wrapper = document.querySelector('.tab-nav-wrapper');
    const nav = wrapper ? wrapper.querySelector('.tab-nav') : null;
    if (!nav || !wrapper) return;

    function updateFade() {
        const atEnd = nav.scrollLeft + nav.clientWidth >= nav.scrollWidth - 4;
        wrapper.classList.toggle('at-end', atEnd);
    }

    nav.addEventListener('scroll', updateFade, { passive: true });
    window.addEventListener('resize', updateFade);
    updateFade();
}

/* Lab range highlight */
const _origConvertLab = window.convertLab;
window.convertLab = function() {
    _origConvertLab.apply(this, arguments);
    // Enhance the result to highlight normal range
    const noteEl = document.getElementById('lab-normal-range');
    if (noteEl && noteEl.textContent) {
        noteEl.innerHTML = `<span class="normal-range-highlight">${noteEl.textContent}</span>`;
    }
};

/* Init */
document.addEventListener('DOMContentLoaded', () => {
    initOfflineIndicator();
    initEnterToCalculate();
    initTabScrollHint();
    initConfirmModal();
    // Copy and clear buttons added after a small delay to let DOM settle
    requestAnimationFrame(() => {
        initCopyResultButtons();
        addClearInputButtons();
    });
});

console.log('MedConvert Improvements Patch loaded.');


/* Improvement pack 2 */

/* Dismiss keyboard before showing result */
(function patchCalculateFunctions() {
    function blurActiveInput() {
        if (document.activeElement && ['INPUT','SELECT'].includes(document.activeElement.tagName)) {
            document.activeElement.blur();
        }
    }
    const calcFns = [
        'calculateDosage','calculateWeightDose','calculateBSA','calculateBSADose',
        'calculateIV','calculateInfusionTime','calculateConcentration',
        'calculateMAP','calculatePP','calculateShockIndex','calculateAAGradient',
        'calculateGCS','calculateBMI','calculateEGFR','calculateWells',
        'calculatePedsWeight','calculatePedsDose','calculateAPGAR',
        'convertLab'
    ];
    calcFns.forEach(name => {
        const orig = window[name];
        if (orig) {
            window[name] = function() {
                blurActiveInput();
                return orig.apply(this, arguments);
            };
        }
    });
})();

/* Collapsible dashboard */
function initCollapsibleDashboard() {
    const toggle = document.getElementById('dashboard-toggle');
    const row = document.getElementById('dashboard-row');
    if (!toggle || !row) return;

    // Start collapsed
    row.style.display = 'none';
    row.style.overflow = 'hidden';
    toggle.setAttribute('aria-expanded', 'false');

    toggle.addEventListener('click', () => {
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        if (isOpen) {
            // Collapse with animation
            row.style.maxHeight = row.scrollHeight + 'px';
            requestAnimationFrame(() => {
                row.style.transition = 'max-height 0.4s cubic-bezier(0.16,1,0.3,1), opacity 0.3s ease';
                row.style.maxHeight = '0';
                row.style.opacity = '0';
            });
            setTimeout(() => { row.style.display = 'none'; row.style.maxHeight = ''; row.style.opacity = ''; }, 420);
            toggle.setAttribute('aria-expanded', 'false');
            row.setAttribute('aria-hidden', 'true');
        } else {
            // Expand with animation
            row.style.display = 'grid';
            row.style.maxHeight = '0';
            row.style.opacity = '0';
            row.style.overflow = 'hidden';
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    row.style.transition = 'max-height 0.45s cubic-bezier(0.16,1,0.3,1), opacity 0.3s ease';
                    row.style.maxHeight = row.scrollHeight + 'px';
                    row.style.opacity = '1';
                });
            });
            setTimeout(() => { row.style.maxHeight = ''; row.style.overflow = ''; }, 460);
            toggle.setAttribute('aria-expanded', 'true');
            row.setAttribute('aria-hidden', 'false');
        }
        if (navigator.vibrate) navigator.vibrate(5);
    });
}

/* Timer label */
function initTimerLabel() {
    const labelInput = document.getElementById('timer-label-input');
    if (!labelInput) return;

    // Update label display inside ring when typing
    labelInput.addEventListener('input', () => {
        const label = document.querySelector('.timer-ring-inner .timer-label');
        if (label) label.textContent = labelInput.value.trim() || 'remaining';
    });

    // Preset buttons set their own label
    const origStartTimer = window.startTimer;
    // Patch each preset button to also set label
    document.querySelectorAll('.timer-btn').forEach(btn => {
        const desc = btn.querySelector('.timer-desc');
        if (!desc) return;
        btn.addEventListener('click', () => {
            if (labelInput) labelInput.value = desc.textContent.trim();
            const label = document.querySelector('.timer-ring-inner .timer-label');
            if (label) label.textContent = desc.textContent.trim();
        }, true); // capture phase so it fires before startTimer
    });
}

/* Drug favorites */
function getDrugFavorites() {
    try { return JSON.parse(localStorage.getItem('medconvert_drug_favs') || '[]'); } catch { return []; }
}
function saveDrugFavorites(favs) {
    try { localStorage.setItem('medconvert_drug_favs', JSON.stringify(favs)); } catch {}
}

window.toggleDrugFav = function(drugName, btn) {
    let favs = getDrugFavorites();
    const isFav = favs.includes(drugName);
    if (isFav) {
        favs = favs.filter(f => f !== drugName);
        btn.classList.remove('is-fav');
        btn.closest('.drug-card').classList.remove('drug-fav-active');
        btn.querySelector('svg').setAttribute('fill', 'none');
        showToast(`${drugName} removed from favorites`, 'info');
    } else {
        favs.push(drugName);
        btn.classList.add('is-fav');
        btn.closest('.drug-card').classList.add('drug-fav-active');
        btn.querySelector('svg').setAttribute('fill', 'currentColor');
        showToast(`${drugName} starred`, 'success');
    }
    saveDrugFavorites(favs);
    if (navigator.vibrate) navigator.vibrate(8);
};

// Override renderAllDrugs to sort favorites to top
const _origRenderAllDrugs = window.renderAllDrugs;
window.renderAllDrugs = function() {
    const el = document.getElementById('drug-results');
    if (!el || !window.DRUG_DB) return;
    const count = document.getElementById('drug-count');
    const favs = getDrugFavorites();
    const sorted = [...DRUG_DB].sort((a, b) => {
        const aFav = favs.includes(a.name) ? -1 : 0;
        const bFav = favs.includes(b.name) ? -1 : 0;
        return aFav - bFav;
    });
    if (count) {
        const favCount = favs.length;
        count.textContent = favCount > 0 ? `${DRUG_DB.length} drugs · ${favCount} starred` : `${DRUG_DB.length} drugs`;
    }
    el.innerHTML = (favs.length > 0 ? '<div class="drug-section-label">Starred</div>' : '') +
        sorted.map((d, i) => {
            const html = buildDrugCard(d);
            if (i === favs.length && favs.length > 0 && favs.length < DRUG_DB.length) {
                return '<div class="drug-section-label" style="margin-top:1rem;">All Drugs</div>' + html;
            }
            return html;
        }).join('');
};

/* Remember last tab */
function initTabStatePersistence() {
    // Save active tab on switch
    const origSwitch = window.switchToTab;
    if (origSwitch) {
        window.switchToTab = function(tabId) {
            origSwitch.apply(this, arguments);
            try { localStorage.setItem('medconvert_last_tab', tabId); } catch {}
        };
    }

    // Restore last active tab on load
    try {
        const lastTab = localStorage.getItem('medconvert_last_tab');
        if (lastTab) {
            const btn = document.querySelector(`.tab-btn[data-tab="${lastTab}"]`);
            if (btn) {
                setTimeout(() => { if (window.switchToTab) window.switchToTab(lastTab); }, 50);
            }
        }
    } catch {}
}

/* Haptic patterns */
function initHapticPatterns() {
    if (!navigator.vibrate) return;

    // Patch showResult to use different haptics based on status
    const origShowResult = window.showResult;
    if (origShowResult) {
        window.showResult = function(resultElId, valueElId, displayValue, status) {
            origShowResult.apply(this, arguments);
            if (status === 'danger') navigator.vibrate([80, 40, 80, 40, 120]);
            else if (status === 'warning') navigator.vibrate([40, 20, 40]);
            else if (status === 'normal') navigator.vibrate([15, 10, 30]);
            else navigator.vibrate(12);
        };
    }

    // Timer done - strong pattern
    // Already handled in timer patch - enhance it
    const origStartTimer = window.startTimer;
    if (origStartTimer) {
        window.startTimer = function(seconds) {
            origStartTimer.apply(this, arguments);
        };
    }
}


function initAutoCalcDefaults() {
    // Trigger GCS calculation immediately so result shows with defaults
    // (Don't auto-trigger - wait for user interaction, just show result display always visible)
    const gcsResult = document.getElementById('gcs-result');
    if (gcsResult) {
        // Make result visible by default for GCS, Wells, APGAR
        // They use selects so defaults are always valid
    }
}

/* Font fallback */
function initFontFallback() {
    // If Google Fonts fails (offline), ensure we have a good fallback chain
    // Add a class to body when fonts load
    if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(() => {
            document.body.classList.add('fonts-loaded');
        }).catch(() => {
            document.body.classList.add('fonts-fallback');
        });
    }

    // Detect if fonts loaded after 2s (offline scenario)
    setTimeout(() => {
        if (!document.body.classList.contains('fonts-loaded')) {
            document.body.classList.add('fonts-fallback');
        }
    }, 2000);
}

/* Dashboard toggle styles */
(function addDashboardToggleStyles() {
    const style = document.createElement('style');
    style.textContent = `
        .dashboard-collapse-wrap {
            margin-bottom: var(--space-8);
        }
        .dashboard-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: var(--space-3) var(--space-5);
            background: var(--bg-card);
            border: var(--outline-card);
            border-radius: var(--radius-xl);
            cursor: pointer;
            font-family: var(--font-body);
            font-size: var(--text-xs);
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.07em;
            transition: all var(--t-smooth);
            min-height: 2.75rem;
        }
        .dashboard-toggle:hover {
            border-color: var(--border-medium);
            color: var(--text-secondary);
        }
        .dashboard-toggle[aria-expanded="true"] {
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-md) var(--radius-md);
            border-bottom-color: transparent;
        }
        .dashboard-toggle-icon {
            width: 1rem;
            height: 1rem;
            transition: transform 0.4s cubic-bezier(0.16,1,0.3,1);
            flex-shrink: 0;
        }
        .dashboard-toggle[aria-expanded="true"] .dashboard-toggle-icon {
            transform: rotate(180deg);
        }
        .dashboard-row {
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
            margin-top: 0;
        }

        /* Timer label field */
        .timer-label-wrap {
            margin-bottom: var(--space-4);
        }
        .timer-label-field {
            width: 100%;
            min-height: 2.75rem;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-family: var(--font-body);
            font-size: var(--text-sm);
            font-weight: 500;
            background: var(--chalk);
            color: var(--text-primary);
            text-align: center;
            transition: border-color var(--t-smooth), box-shadow var(--t-smooth);
            outline: none;
            -webkit-tap-highlight-color: rgba(157,201,144,0.18);
        }
        .timer-label-field:focus {
            border-color: var(--border-focus);
            box-shadow: var(--focus-ring);
        }
        .timer-label-field::placeholder {
            color: var(--text-muted);
            font-weight: 400;
            font-size: var(--text-xs);
        }

        /* Drug favorites */
        .drug-fav-btn {
            background: transparent;
            border: none;
            padding: 0.25rem;
            cursor: pointer;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: color var(--t-fast), transform var(--t-bounce);
            -webkit-tap-highlight-color: transparent;
            min-width: 2rem;
            min-height: 2rem;
        }
        .drug-fav-btn svg { width: 1rem; height: 1rem; }
        .drug-fav-btn:hover { color: var(--amber); transform: scale(1.15); }
        .drug-fav-btn.is-fav { color: var(--amber); }
        .drug-fav-btn.is-fav:hover { transform: scale(1.2) rotate(-5deg); }
        .drug-fav-active { border-color: var(--amber) !important; }
        .drug-section-label {
            font-size: var(--text-xs);
            font-weight: 700;
            font-family: var(--font-body);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            padding: var(--space-2) 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: var(--space-3);
        }

        /* Font fallback */
        .fonts-fallback h1, .fonts-fallback h2, .fonts-fallback h3,
        .fonts-fallback h4, .fonts-fallback .card-title,
        .fonts-fallback .result-value, .fonts-fallback .daily-message {
            font-family: Georgia, 'Times New Roman', serif;
        }
        .fonts-fallback body, .fonts-fallback .btn, .fonts-fallback input,
        .fonts-fallback select, .fonts-fallback textarea {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Auto-calculate visual cue - pulse the result when it updates live */
        @keyframes liveUpdate {
            0%   { opacity: 0.6; transform: scale(0.99); }
            100% { opacity: 1;   transform: scale(1); }
        }
        .result-live-update {
            animation: liveUpdate 0.3s cubic-bezier(0.16,1,0.3,1);
        }
    `;
    document.head.appendChild(style);
})();

/* Init */
document.addEventListener('DOMContentLoaded', () => {
    initCollapsibleDashboard();
    initTimerLabel();
    initTabStatePersistence();
    initHapticPatterns();
    initFontFallback();
    // Render drugs with favorites sorted on init
    setTimeout(() => {
        if (window.renderAllDrugs) window.renderAllDrugs();
    }, 100);
});

/* Live result pulse */
const origShowResult2 = window.showResult;
if (origShowResult2) {
    window.showResult = function(resultElId) {
        origShowResult2.apply(this, arguments);
        const el = document.getElementById(resultElId);
        if (el) {
            el.classList.remove('result-live-update');
            requestAnimationFrame(() => el.classList.add('result-live-update'));
        }
    };
}

console.log('Improvement Pack 2 loaded — all 8 fixes active.');

</script>

<!-- ==================== CONFIRM MODAL ==================== -->
<div id="confirm-modal" class="confirm-overlay" role="dialog" aria-modal="true" aria-labelledby="confirm-title">
    <div class="confirm-card">
        <h3 class="confirm-title" id="confirm-title">Clear All Notes?</h3>
        <p class="confirm-body">This action cannot be undone. All your shift notes will be permanently deleted.</p>
        <div class="confirm-actions">
            <button class="btn btn-secondary" id="confirm-cancel">Cancel</button>
            <button class="btn btn-accent" id="confirm-ok">Clear All Notes</button>
        </div>
    </div>
</div>
</body>
</html>